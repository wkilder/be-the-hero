{"version":3,"sources":["Project.ts"],"names":["EXPO_CDN","MINIMUM_BUNDLE_SIZE","TUNNEL_TIMEOUT","treekillAsync","treekill","ngrokConnectAsync","ngrok","connect","ngrokKillAsync","kill","_cachedSignedManifest","manifestString","signedManifest","currentStatus","projectDir","packagerPort","expoServerPort","ProjectSettings","readPackagerInfoAsync","getDefaultTargetAsync","exp","skipSDKVersionRequirement","sdkVersion","semver","lt","isBareWorkflowProjectAsync","pkg","dependencies","expokit","fs","existsSync","path","resolve","xcodeprojFiles","join","length","gradleFiles","getManifestUrlWithFallbackAsync","projectRoot","url","UrlUtils","constructManifestUrlAsync","isUrlFallback","_assertValidProjectRoot","XDLError","_getFreePortAsync","rangeStart","port","hostnames","_getForPlatformAsync","platform","errorCode","minLength","fullUrl","response","axios","get","responseType","transformResponse","data","proxy","validateStatus","status","headers","error","body","JSON","parse","e","ProjectUtils","logError","message","_resolveGoogleServicesFile","manifest","android","googleServicesFile","contents","readFile","ios","_resolveManifestAssets","resolver","strict","assetSchemas","ExpSchema","getAssetSchemasAsync","filter","assetSchema","fieldPath","urls","Promise","all","map","pathOrURL","match","err","Error","localAssetPath","manifestField","forEach","index","logMethod","logWarning","_requireFromProject","modulePath","fullPath","require","getSlugAsync","slug","getLatestReleaseAsync","options","result","process","env","EXPO_LEGACY_API","formData","FormData","append","owner","releaseChannel","Api","callMethodAsync","user","UserManager","ensureLoggedInAsync","api","ApiV2","clientForUser","postAsync","count","queryResult","mergeAppDistributions","sourceDirs","outputDir","assetPathToWrite","ensureDir","bundlesPathToWrite","androidIndexes","iosIndexes","sourceDir","promises","sourceAssetDir","outputAssetDir","assetPromise","copy","push","sourceBundleDir","outputBundleDir","bundlePromise","putJsonInMemory","indexPath","accumulator","JsonFile","readAsync","Array","isArray","androidIndexPath","iosIndexPath","getSortedIndex","indexes","sort","index1","index2","eq","logger","global","gte","sortedAndroidIndexes","sortedIosIndexes","_writeArtifactSafelyAsync","stringify","exportForAppHosting","publicUrl","assetUrl","_validatePackagerReadyAsync","packagerOpts","dev","isDev","minify","iosBundle","androidBundle","_buildPublishBundlesAsync","iosBundleHash","crypto","createHash","update","digest","iosBundleUrl","iosJsPath","androidBundleHash","androidBundleUrl","androidJsPath","info","publishOptions","_getPublishExpConfigAsync","assets","_fetchAndSaveAssetsAsync","dumpAssetmap","assetmap","asset","hash","hooks","assetUrlOverride","publishedTime","Date","toISOString","commitTime","hashIds","HashIds","uuid","v1","revisionId","encode","now","developer","tool","username","getCurrentUsernameAsync","ANONYMOUS_USERNAME","id","bundleUrl","Object","keys","dumpSourcemap","iosSourceMap","androidSourceMap","_buildSourceMapsAsync","iosMapName","iosMapPath","androidMapName","androidMapPath","truncateLastNLines","appendFile","debugHtml","filePath","n","lines","readLastLines","read","to_vanquish","size","stat","truncate","_saveAssetAsync","paths","files","fileHashes","keyChunks","key","logDebug","quiet","assetPath","p","findReusableBuildAsync","getCurrentUserAsync","buildReuseStatus","publishAsync","Analytics","logEvent","developerTool","Config","validationStatus","Doctor","validateWithNetworkAsync","ERROR","FATAL","validPostPublishHooks","postPublish","hook","file","fn","_fn","_fetchAndUploadAssetsAsync","hasHooks","shouldPublishAndroidMaps","publishSourceMapPath","shouldPublishIosMaps","_maybeBuildSourceMapsAsync","force","_uploadArtifactsAsync","serverError","Sentry","captureException","_maybeWriteArtifactsToDiskAsync","publishManifestPath","androidManifest","iosManifest","ExponentTools","getManifestAsync","Accept","hookOptions","log","msg","config","then","warn","stack","fullManifestUrl","replace","context","StandaloneContext","createUserContext","supportingDirectory","IosWorkspace","getPaths","IosPlist","modifyAsync","shellPlist","configPlist","EXUpdatesURL","EXUpdatesReleaseChannel","EXUpdatesSDKVersion","publishBundlePath","constantsPath","deleteLinesInFileAsync","regexFileAsync","androidManifestXmlPath","androidManifestXmlFile","readFileSync","expoUpdateUrlRegex","expoSdkVersionRegex","expoReleaseChannelRegex","expoUpdateUrlTag","expoSdkVersionTag","expoReleaseChannelTag","tagsToInsert","search","isKernel","_handleKernelPublishedAsync","uploadFormDataAsync","packagerInfo","startReactNativeServerAsync","reset","schema","joi","object","string","validate","toString","locales","getResolvedLocalesAsync","opts","entryPoint","Exp","determineEntryPoint","publishUrl","constructPublishUrlAsync","undefined","sourceMapUrl","constructSourceMapUrlAsync","_collectAssets","hostedAssetPrefix","assetsUrl","constructAssetsUrlAsync","iosAssetsJson","androidAssetsJson","manifestAssets","absolutePath","iosAssets","androidAssets","concat","_configureExpForAssets","assetBundlePatterns","fullPatterns","bundledAssets","Set","shouldBundle","__packager_asset","some","add","type","assetCdnPath","uploadAssetsAsync","hostedUrl","keyName","artifactPath","artifact","pathToWrite","dirname","errorMsg","writeFile","kernelBundleUrl","scheme","host","kernel","androidManifestPath","iosManifestPath","metas","metadata","missing","exists","relativePath","createReadStream","getConfigAsync","configName","configPrefix","ThirdParty","getManifest","_validateManifest","bundleIdentifier","package","_validateOptions","current","boolean","mode","any","valid","expIds","array","regex","_getExpAsync","version","name","toLowerCase","getBuildStatusAsync","startBuildAsync","putAsync","buildAsync","_waitForRunningAsync","retries","test","METRO_VERBOSE_WARNING","NODE_12_WINDOWS_METRO_ERROR","NODE_12_WINDOWS_METRO_SUGGESTION","_logPackagerOutput","level","output","_isIgnorableDuplicateModuleWarning","_isIgnorableMetroConsoleOutput","_isIgnorableRnpmWarning","includes","logInfo","startsWith","reactNativeNodeModulesPath","reactNativeNodeModulesPattern","reactNativeNodeModulesCollisionRegex","RegExp","_isIgnorableBugReportingExtraData","_isAppRegistryStartupMessage","_handleDeviceLogs","deviceId","deviceName","logs","i","DEBUG","obj","logWithLevel","tag","groupDepth","shouldHide","includesStack","verbose","stopReactNativeServerAsync","Watchman","addToPathAsync","unblockAndGetVersionAsync","customLogReporterPath","__dirname","sourceExtsConfig","isTS","isReact","isModern","sourceExts","target","nonPersistent","Versions","lteSdkVersion","gteSdkVersion","assetPlugins","maxWorkers","userPackagerOpts","cliOpts","val","EXPO_DEBUG","defaultCliPath","cliPath","rnCliPath","nodePath","_nodePathForProjectRoot","nodePathEnv","NODE_PATH","packagerProcess","child_process","fork","cwd","REACT_NATIVE_APP_ROOT","ELECTRON_RUN_AS_NODE","silent","setPackagerInfoAsync","packagerPid","pid","on","stdout","stderr","setEncoding","pipe","exitPromise","reject","once","code","packagerUrl","constructBundleUrlAsync","urlType","hostType","race","directory","parentDirectory","delimiter","blacklistedEnvironmentVariables","shouldExposeEnvironmentVariableInManifest","has","toUpperCase","startExpoServerAsync","stopExpoServerAsync","app","use","express","json","limit","urlencoded","extended","ConnectionStatus","isOffline","validateWithoutNetworkAsync","manifestHandler","req","res","bundleUrlPackagerOpts","xde","mainModuleName","guessMainModulePath","queryParams","constructBundleQueryParamsAsync","encodeURI","encodeURIComponent","hostname","debuggerHost","constructDebuggerHostAsync","logUrl","constructLogUrlAsync","hostUri","constructHostUriAsync","hostUUID","UserSettings","anonymousIdentifier","currentSession","getSessionAsync","offline","unsignedManifest","signature","publishInfo","getPublishInfoAsync","args","hostInfo","server","serverVersion","serverDriver","serverOS","os","serverOSVersion","release","send","post","close","expRc","manifestPort","listen","address","saveRecentExpRootAsync","_connectToNgrokAsync","hostnameAsync","ngrokPid","attempts","configPath","dotExpoHomeDirectory","error_code","resetProjectRandomnessAsync","startTunnelsAsync","stopTunnelsAsync","Android","startAdbReverseAsync","packageShortName","base","startedTunnelsSuccessfully","expoServerNgrokUrl","authtoken","authToken","proto","randomness","manifestTunnelRandomness","getProjectRandomnessAsync","domainify","domain","packagerNgrokUrl","_expoEventType","addListener","ngrokProcess","ngrokProcessPid","removeAllListeners","stopAdbReverseAsync","setOptionsAsync","number","integer","getUrlAsync","startAsync","webOnly","Webpack","restartAsync","DevSession","startSession","_stopInternalAsync","stopSession","stopAsync","stopWebOnlyAsync","setTimeout","webpackServerPort"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAUA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAA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","sourcesContent":["import {\n  ExpoConfig,\n  PackageJSONConfig,\n  Platform,\n  configFilename,\n  getConfig,\n  readExpRcAsync,\n  resolveModule,\n} from '@expo/config';\n\nimport slug from 'slugify';\nimport { getBareExtensions, getManagedExtensions } from '@expo/config/paths';\nimport JsonFile from '@expo/json-file';\nimport ngrok from '@expo/ngrok';\nimport axios from 'axios';\nimport child_process from 'child_process';\nimport crypto from 'crypto';\nimport decache from 'decache';\nimport delayAsync from 'delay-async';\nimport express from 'express';\nimport freeportAsync from 'freeport-async';\nimport fs from 'fs-extra';\nimport glob from 'glob-promise';\nimport HashIds from 'hashids';\nimport joi from 'joi';\nimport chunk from 'lodash/chunk';\nimport escapeRegExp from 'lodash/escapeRegExp';\nimport get from 'lodash/get';\nimport reduce from 'lodash/reduce';\nimport set from 'lodash/set';\nimport uniq from 'lodash/uniq';\nimport md5hex from 'md5hex';\nimport minimatch from 'minimatch';\nimport { AddressInfo } from 'net';\nimport os from 'os';\nimport path from 'path';\nimport readLastLines from 'read-last-lines';\nimport semver from 'semver';\nimport split from 'split';\nimport treekill from 'tree-kill';\nimport urljoin from 'url-join';\nimport { promisify } from 'util';\nimport uuid from 'uuid';\n\nimport * as Analytics from './Analytics';\nimport * as Android from './Android';\nimport Api from './Api';\nimport ApiV2 from './ApiV2';\nimport Config from './Config';\nimport * as ExponentTools from './detach/ExponentTools';\nimport StandaloneContext from './detach/StandaloneContext';\nimport * as DevSession from './DevSession';\nimport { maySkipManifestValidation } from './Env';\nimport { ErrorCode } from './ErrorCode';\nimport * as Exp from './Exp';\nimport logger from './Logger';\nimport * as ExpSchema from './project/ExpSchema';\nimport * as ProjectUtils from './project/ProjectUtils';\nimport * as ProjectSettings from './ProjectSettings';\nimport * as Sentry from './Sentry';\nimport * as ThirdParty from './ThirdParty';\nimport FormData from './tools/FormData';\nimport * as UrlUtils from './UrlUtils';\nimport UserManager, { ANONYMOUS_USERNAME, User } from './User';\nimport UserSettings from './UserSettings';\nimport * as Versions from './Versions';\nimport * as Watchman from './Watchman';\nimport * as Webpack from './Webpack';\nimport XDLError from './XDLError';\n\nimport * as Doctor from './project/Doctor';\nimport * as IosPlist from './detach/IosPlist';\n// @ts-ignore IosWorkspace not yet converted to TypeScript\nimport * as IosWorkspace from './detach/IosWorkspace';\nimport { ConnectionStatus } from './xdl';\n\nconst EXPO_CDN = 'https://d1wp6m56sqw74a.cloudfront.net';\nconst MINIMUM_BUNDLE_SIZE = 500;\nconst TUNNEL_TIMEOUT = 10 * 1000;\n\nconst treekillAsync = promisify(treekill);\nconst ngrokConnectAsync = promisify(ngrok.connect);\nconst ngrokKillAsync = promisify(ngrok.kill);\n\ntype CachedSignedManifest =\n  | {\n      manifestString: null;\n      signedManifest: null;\n    }\n  | {\n      manifestString: string;\n      signedManifest: string;\n    };\n\nlet _cachedSignedManifest: CachedSignedManifest = {\n  manifestString: null,\n  signedManifest: null,\n};\n\ntype Asset =\n  | { fileHashes: string[]; files: string[]; hash: string }\n  | {\n      __packager_asset: true;\n      fileHashes: string[];\n      files: string[];\n      fileSystemLocation: string;\n      hash: string;\n      httpServerLocation: string;\n      name: string;\n      scales: number[];\n      type: string;\n    };\n\ntype ManifestResolutionError = Error & {\n  localAssetPath?: string;\n  manifestField?: string;\n};\n\ntype PublicConfig = ExpoConfig & {\n  sdkVersion: string;\n};\n\ntype SelfHostedIndex = PublicConfig & {\n  dependencies: string[];\n};\n\nexport type StartOptions = {\n  reset?: boolean;\n  nonInteractive?: boolean;\n  nonPersistent?: boolean;\n  maxWorkers?: number;\n  webOnly?: boolean;\n  target?: ProjectTarget;\n};\n\ntype PublishOptions = {\n  releaseChannel?: string;\n};\n\ntype PackagerOptions = {\n  dev: boolean;\n  minify: boolean;\n};\n\ntype HookArguments = {\n  config: any;\n  url: any;\n  exp: PublicConfig;\n  iosBundle: string;\n  iosSourceMap: string | null;\n  iosManifest: any;\n  androidBundle: string;\n  androidSourceMap: string | null;\n  androidManifest: any;\n  projectRoot: string;\n  log: (msg: any) => void;\n};\n\ntype PostPublishHook = {\n  file: string;\n  config: any;\n  _fn: (input: HookArguments) => any;\n};\n\ntype Release = {\n  fullName: string;\n  channel: string;\n  channelId: string;\n  publicationId: string;\n  appVersion: string;\n  sdkVersion: string;\n  publishedTime: string;\n  platform: string;\n};\n\nexport type ProjectStatus = 'running' | 'ill' | 'exited';\n\nexport async function currentStatus(projectDir: string): Promise<ProjectStatus> {\n  const { packagerPort, expoServerPort } = await ProjectSettings.readPackagerInfoAsync(projectDir);\n  if (packagerPort && expoServerPort) {\n    return 'running';\n  } else if (packagerPort || expoServerPort) {\n    return 'ill';\n  } else {\n    return 'exited';\n  }\n}\n\nexport type ProjectTarget = 'managed' | 'bare';\n\nexport async function getDefaultTargetAsync(projectDir: string): Promise<ProjectTarget> {\n  const { exp } = getConfig(projectDir, { skipSDKVersionRequirement: true });\n  // before SDK 37, always default to managed to preserve previous behavior\n  if (exp.sdkVersion && semver.lt(exp.sdkVersion, '37.0.0')) {\n    return 'managed';\n  }\n  return (await isBareWorkflowProjectAsync(projectDir)) ? 'bare' : 'managed';\n}\n\nexport async function isBareWorkflowProjectAsync(projectDir: string): Promise<boolean> {\n  const { pkg } = getConfig(projectDir, {\n    skipSDKVersionRequirement: true,\n  });\n  if (pkg.dependencies && pkg.dependencies.expokit) {\n    return false;\n  }\n\n  if (fs.existsSync(path.resolve(projectDir, 'ios'))) {\n    const xcodeprojFiles = await glob(path.join(projectDir, 'ios', '/**/*.xcodeproj'));\n    if (xcodeprojFiles && xcodeprojFiles.length) {\n      return true;\n    }\n  }\n  if (fs.existsSync(path.resolve(projectDir, 'android'))) {\n    const gradleFiles = await glob(path.join(projectDir, 'android', '/**/*.gradle'));\n    if (gradleFiles && gradleFiles.length) {\n      return true;\n    }\n  }\n\n  return false;\n}\n\n// DECPRECATED: use UrlUtils.constructManifestUrlAsync\nexport async function getManifestUrlWithFallbackAsync(\n  projectRoot: string\n): Promise<{ url: string; isUrlFallback: false }> {\n  return {\n    url: await UrlUtils.constructManifestUrlAsync(projectRoot),\n    isUrlFallback: false,\n  };\n}\n\nasync function _assertValidProjectRoot(projectRoot: string) {\n  if (!projectRoot) {\n    throw new XDLError('NO_PROJECT_ROOT', 'No project root specified');\n  }\n}\n\nasync function _getFreePortAsync(rangeStart: number) {\n  let port = await freeportAsync(rangeStart, { hostnames: [null, 'localhost'] });\n  if (!port) {\n    throw new XDLError('NO_PORT_FOUND', 'No available port found');\n  }\n\n  return port;\n}\n\nasync function _getForPlatformAsync(\n  projectRoot: string,\n  url: string,\n  platform: Platform,\n  { errorCode, minLength }: { errorCode: ErrorCode; minLength?: number }\n): Promise<string> {\n  let fullUrl = `${url}&platform=${platform}`;\n  let response;\n\n  try {\n    response = await axios.get(fullUrl, {\n      responseType: 'text',\n      // Workaround for https://github.com/axios/axios/issues/907.\n      // Without transformResponse, axios will parse the body as JSON regardless of the responseType/\n      transformResponse: [data => data],\n      proxy: false,\n      validateStatus: status => status === 200,\n      headers: {\n        'Exponent-Platform': platform,\n      },\n    });\n  } catch (error) {\n    if (error.response) {\n      if (error.response.data) {\n        let body;\n        try {\n          body = JSON.parse(error.response.data);\n        } catch (e) {\n          ProjectUtils.logError(projectRoot, 'expo', error.response.data);\n        }\n\n        if (body) {\n          if (body.message) {\n            ProjectUtils.logError(projectRoot, 'expo', body.message);\n          } else {\n            ProjectUtils.logError(projectRoot, 'expo', error.response.data);\n          }\n        }\n      }\n      throw new XDLError(\n        errorCode,\n        `Packager URL ${fullUrl} returned unexpected code ${error.response.status}. ` +\n          'Please open your project in the Expo app and see if there are any errors. ' +\n          'Also scroll up and make sure there were no errors or warnings when opening your project.'\n      );\n    } else {\n      throw error;\n    }\n  }\n\n  if (!response.data || (minLength && response.data.length < minLength)) {\n    throw new XDLError(errorCode, `Body is: ${response.data}`);\n  }\n\n  return response.data;\n}\n\nasync function _resolveGoogleServicesFile(projectRoot: string, manifest: ExpoConfig) {\n  if (manifest.android && manifest.android.googleServicesFile) {\n    const contents = await fs.readFile(\n      path.resolve(projectRoot, manifest.android.googleServicesFile),\n      'utf8'\n    );\n    manifest.android.googleServicesFile = contents;\n  }\n  if (manifest.ios && manifest.ios.googleServicesFile) {\n    const contents = await fs.readFile(\n      path.resolve(projectRoot, manifest.ios.googleServicesFile),\n      'base64'\n    );\n    manifest.ios.googleServicesFile = contents;\n  }\n}\n\nasync function _resolveManifestAssets(\n  projectRoot: string,\n  manifest: PublicConfig,\n  resolver: (assetPath: string) => Promise<string>,\n  strict = false\n) {\n  try {\n    // Asset fields that the user has set\n    const assetSchemas = (\n      await ExpSchema.getAssetSchemasAsync(manifest.sdkVersion)\n    ).filter((assetSchema: ExpSchema.AssetSchema) => get(manifest, assetSchema.fieldPath));\n\n    // Get the URLs\n    const urls = await Promise.all(\n      assetSchemas.map(async (assetSchema: ExpSchema.AssetSchema) => {\n        const pathOrURL = get(manifest, assetSchema.fieldPath);\n        if (pathOrURL.match(/^https?:\\/\\/(.*)$/)) {\n          // It's a remote URL\n          return pathOrURL;\n        } else if (fs.existsSync(path.resolve(projectRoot, pathOrURL))) {\n          return await resolver(pathOrURL);\n        } else {\n          const err: ManifestResolutionError = new Error('Could not resolve local asset.');\n          err.localAssetPath = pathOrURL;\n          err.manifestField = assetSchema.fieldPath;\n          throw err;\n        }\n      })\n    );\n\n    // Set the corresponding URL fields\n    assetSchemas.forEach((assetSchema: ExpSchema.AssetSchema, index: number) =>\n      set(manifest, assetSchema.fieldPath + 'Url', urls[index])\n    );\n  } catch (e) {\n    let logMethod = ProjectUtils.logWarning;\n    if (strict) {\n      logMethod = ProjectUtils.logError;\n    }\n    if (e.localAssetPath) {\n      logMethod(\n        projectRoot,\n        'expo',\n        `Unable to resolve asset \"${e.localAssetPath}\" from \"${e.manifestField}\" in your app/exp.json.`\n      );\n    } else {\n      logMethod(\n        projectRoot,\n        'expo',\n        `Warning: Unable to resolve manifest assets. Icons might not work. ${e.message}.`\n      );\n    }\n\n    if (strict) {\n      throw new Error('Resolving assets failed.');\n    }\n  }\n}\n\nfunction _requireFromProject(modulePath: string, projectRoot: string, exp: ExpoConfig) {\n  try {\n    let fullPath = resolveModule(modulePath, projectRoot, exp);\n    // Clear the require cache for this module so get a fresh version of it\n    // without requiring the user to restart Expo CLI\n    decache(fullPath);\n    // $FlowIssue: doesn't work with dynamic requires\n    return require(fullPath);\n  } catch (e) {\n    return null;\n  }\n}\n\n// TODO: Move to @expo/config\nexport async function getSlugAsync(projectRoot: string): Promise<string> {\n  const { exp } = getConfig(projectRoot, { skipSDKVersionRequirement: true });\n  if (exp.slug) {\n    return exp.slug;\n  }\n  throw new XDLError(\n    'INVALID_MANIFEST',\n    `Your project config in ${projectRoot} must contain a \"slug\" field. Please supply this in your app.config.js or app.json`\n  );\n}\n\nexport async function getLatestReleaseAsync(\n  projectRoot: string,\n  options: {\n    releaseChannel: string;\n    platform: string;\n    owner?: string;\n  }\n): Promise<Release | null> {\n  let result;\n  if (process.env.EXPO_LEGACY_API === 'true') {\n    // TODO(ville): move request from multipart/form-data to JSON once supported by the endpoint.\n    let formData = new FormData();\n    formData.append('queryType', 'history');\n    formData.append('slug', await getSlugAsync(projectRoot));\n    if (options.owner) {\n      formData.append('owner', options.owner);\n    }\n    formData.append('version', '2');\n    formData.append('count', '1');\n    formData.append('releaseChannel', options.releaseChannel);\n    formData.append('platform', options.platform);\n    result = await Api.callMethodAsync('publishInfo', [], 'post', null, {\n      formData,\n    });\n  } else {\n    const user = await UserManager.ensureLoggedInAsync();\n    const api = ApiV2.clientForUser(user);\n    result = await api.postAsync('publish/history', {\n      owner: options.owner,\n      slug: await getSlugAsync(projectRoot),\n      releaseChannel: options.releaseChannel,\n      count: 1,\n      platform: options.platform,\n    });\n  }\n  const { queryResult } = result;\n  if (queryResult && queryResult.length > 0) {\n    return queryResult[0];\n  } else {\n    return null;\n  }\n}\n\n// Takes multiple exported apps in sourceDirs and coalesces them to one app in outputDir\nexport async function mergeAppDistributions(\n  projectRoot: string,\n  sourceDirs: Array<string>,\n  outputDir: string\n): Promise<void> {\n  const assetPathToWrite = path.resolve(projectRoot, outputDir, 'assets');\n  await fs.ensureDir(assetPathToWrite);\n  const bundlesPathToWrite = path.resolve(projectRoot, outputDir, 'bundles');\n  await fs.ensureDir(bundlesPathToWrite);\n\n  // merge files from bundles and assets\n  const androidIndexes: SelfHostedIndex[] = [];\n  const iosIndexes: SelfHostedIndex[] = [];\n\n  for (let sourceDir of sourceDirs) {\n    const promises = [];\n\n    // copy over assets/bundles from other src dirs to the output dir\n    if (sourceDir !== outputDir) {\n      // copy file over to assetPath\n      const sourceAssetDir = path.resolve(projectRoot, sourceDir, 'assets');\n      const outputAssetDir = path.resolve(projectRoot, outputDir, 'assets');\n      const assetPromise = fs.copy(sourceAssetDir, outputAssetDir);\n      promises.push(assetPromise);\n\n      // copy files over to bundlePath\n      const sourceBundleDir = path.resolve(projectRoot, sourceDir, 'bundles');\n      const outputBundleDir = path.resolve(projectRoot, outputDir, 'bundles');\n      const bundlePromise = fs.copy(sourceBundleDir, outputBundleDir);\n      promises.push(bundlePromise);\n\n      await Promise.all(promises);\n    }\n\n    // put index.jsons into memory\n    const putJsonInMemory = async (indexPath: string, accumulator: SelfHostedIndex[]) => {\n      const index = (await JsonFile.readAsync(indexPath)) as SelfHostedIndex;\n      if (!index.sdkVersion) {\n        throw new XDLError(\n          'INVALID_MANIFEST',\n          `Invalid index.json, must specify an sdkVersion at ${indexPath}`\n        );\n      }\n      if (Array.isArray(index)) {\n        // index.json could also be an array\n        accumulator.push(...index);\n      } else {\n        accumulator.push(index);\n      }\n    };\n\n    const androidIndexPath = path.resolve(projectRoot, sourceDir, 'android-index.json');\n    await putJsonInMemory(androidIndexPath, androidIndexes);\n\n    const iosIndexPath = path.resolve(projectRoot, sourceDir, 'ios-index.json');\n    await putJsonInMemory(iosIndexPath, iosIndexes);\n  }\n\n  // sort indexes by descending sdk value\n  const getSortedIndex = (indexes: SelfHostedIndex[]) => {\n    return indexes.sort((index1: SelfHostedIndex, index2: SelfHostedIndex) => {\n      if (semver.eq(index1.sdkVersion, index2.sdkVersion)) {\n        logger.global.error(\n          `Encountered multiple index.json with the same SDK version ${index1.sdkVersion}. This could result in undefined behavior.`\n        );\n      }\n      return semver.gte(index1.sdkVersion, index2.sdkVersion) ? -1 : 1;\n    });\n  };\n\n  const sortedAndroidIndexes = getSortedIndex(androidIndexes);\n  const sortedIosIndexes = getSortedIndex(iosIndexes);\n\n  // Save the json arrays to disk\n  await _writeArtifactSafelyAsync(\n    projectRoot,\n    null,\n    path.join(outputDir, 'android-index.json'),\n    JSON.stringify(sortedAndroidIndexes)\n  );\n\n  await _writeArtifactSafelyAsync(\n    projectRoot,\n    null,\n    path.join(outputDir, 'ios-index.json'),\n    JSON.stringify(sortedIosIndexes)\n  );\n}\n\n/**\n * Apps exporting for self hosting will have the files created in the project directory the following way:\n.\n├── android-index.json\n├── ios-index.json\n├── assets\n│   └── 1eccbc4c41d49fd81840aef3eaabe862\n└── bundles\n      ├── android-01ee6e3ab3e8c16a4d926c91808d5320.js\n      └── ios-ee8206cc754d3f7aa9123b7f909d94ea.js\n */\nexport async function exportForAppHosting(\n  projectRoot: string,\n  publicUrl: string,\n  assetUrl: string,\n  outputDir: string,\n  options: {\n    isDev?: boolean;\n    dumpAssetmap?: boolean;\n    dumpSourcemap?: boolean;\n    publishOptions?: PublishOptions;\n  } = {}\n): Promise<void> {\n  await _validatePackagerReadyAsync(projectRoot);\n\n  // build the bundles\n  let packagerOpts = {\n    dev: !!options.isDev,\n    minify: true,\n  };\n  // make output dirs if not exists\n  const assetPathToWrite = path.resolve(projectRoot, path.join(outputDir, 'assets'));\n  await fs.ensureDir(assetPathToWrite);\n  const bundlesPathToWrite = path.resolve(projectRoot, path.join(outputDir, 'bundles'));\n  await fs.ensureDir(bundlesPathToWrite);\n\n  const { iosBundle, androidBundle } = await _buildPublishBundlesAsync(projectRoot, packagerOpts);\n  const iosBundleHash = crypto\n    .createHash('md5')\n    .update(iosBundle)\n    .digest('hex');\n  const iosBundleUrl = `ios-${iosBundleHash}.js`;\n  const iosJsPath = path.join(outputDir, 'bundles', iosBundleUrl);\n\n  const androidBundleHash = crypto\n    .createHash('md5')\n    .update(androidBundle)\n    .digest('hex');\n  const androidBundleUrl = `android-${androidBundleHash}.js`;\n  const androidJsPath = path.join(outputDir, 'bundles', androidBundleUrl);\n\n  await _writeArtifactSafelyAsync(projectRoot, null, iosJsPath, iosBundle);\n  await _writeArtifactSafelyAsync(projectRoot, null, androidJsPath, androidBundle);\n  logger.global.info('Finished saving JS Bundles.');\n\n  // save the assets\n  // Get project config\n  const publishOptions = options.publishOptions || {};\n  const { exp, pkg } = await _getPublishExpConfigAsync(projectRoot, publishOptions);\n  const { assets } = await _fetchAndSaveAssetsAsync(projectRoot, exp, publicUrl, outputDir);\n\n  if (options.dumpAssetmap) {\n    logger.global.info('Dumping asset map.');\n    const assetmap: { [hash: string]: Asset } = {};\n    assets.forEach((asset: Asset) => {\n      assetmap[asset.hash] = asset;\n    });\n    await _writeArtifactSafelyAsync(\n      projectRoot,\n      null,\n      path.join(outputDir, 'assetmap.json'),\n      JSON.stringify(assetmap)\n    );\n  }\n\n  // Delete keys that are normally deleted in the publish process\n  delete exp.hooks;\n\n  // Add assetUrl to manifest\n  exp.assetUrlOverride = assetUrl;\n\n  exp.publishedTime = new Date().toISOString();\n  exp.commitTime = new Date().toISOString();\n\n  // generate revisionId and id the same way www does\n  const hashIds = new HashIds(uuid.v1(), 10);\n  exp.revisionId = hashIds.encode(Date.now());\n\n  if (options.isDev) {\n    exp.developer = {\n      tool: 'exp',\n    };\n  }\n\n  if (!exp.slug) {\n    throw new XDLError('INVALID_MANIFEST', 'Must provide a slug field in the app.json manifest.');\n  }\n  let username = await UserManager.getCurrentUsernameAsync();\n  if (!username) {\n    username = ANONYMOUS_USERNAME;\n  }\n  exp.id = `@${username}/${exp.slug}`;\n\n  // save the android manifest\n  exp.bundleUrl = urljoin(publicUrl, 'bundles', androidBundleUrl);\n  exp.platform = 'android';\n  await _writeArtifactSafelyAsync(\n    projectRoot,\n    null,\n    path.join(outputDir, 'android-index.json'),\n    JSON.stringify({ ...exp, dependencies: Object.keys(pkg.dependencies) })\n  );\n\n  // save the ios manifest\n  exp.bundleUrl = urljoin(publicUrl, 'bundles', iosBundleUrl);\n  exp.platform = 'ios';\n  await _writeArtifactSafelyAsync(\n    projectRoot,\n    null,\n    path.join(outputDir, 'ios-index.json'),\n    JSON.stringify(exp)\n  );\n\n  // build source maps\n  if (options.dumpSourcemap) {\n    const { iosSourceMap, androidSourceMap } = await _buildSourceMapsAsync(projectRoot, exp);\n    // write the sourcemap files\n    const iosMapName = `ios-${iosBundleHash}.map`;\n    const iosMapPath = path.join(outputDir, 'bundles', iosMapName);\n    await _writeArtifactSafelyAsync(projectRoot, null, iosMapPath, iosSourceMap);\n\n    const androidMapName = `android-${androidBundleHash}.map`;\n    const androidMapPath = path.join(outputDir, 'bundles', androidMapName);\n    await _writeArtifactSafelyAsync(projectRoot, null, androidMapPath, androidSourceMap);\n\n    // Remove original mapping to incorrect sourcemap paths\n    logger.global.info('Configuring sourcemaps');\n    await truncateLastNLines(iosJsPath, 1);\n    await truncateLastNLines(androidJsPath, 1);\n\n    // Add correct mapping to sourcemap paths\n    await fs.appendFile(iosJsPath, `\\n//# sourceMappingURL=${iosMapName}`);\n    await fs.appendFile(androidJsPath, `\\n//# sourceMappingURL=${androidMapName}`);\n\n    // Make a debug html so user can debug their bundles\n    logger.global.info('Preparing additional debugging files');\n    const debugHtml = `\n    <script src=\"${urljoin('bundles', iosBundleUrl)}\"></script>\n    <script src=\"${urljoin('bundles', androidBundleUrl)}\"></script>\n    Open up this file in Chrome. In the Javascript developer console, navigate to the Source tab.\n    You can see a red coloured folder containing the original source code from your bundle.\n    `;\n    await _writeArtifactSafelyAsync(\n      projectRoot,\n      null,\n      path.join(outputDir, 'debug.html'),\n      debugHtml\n    );\n  }\n}\n\n// truncate the last n lines in a file\nasync function truncateLastNLines(filePath: string, n: number) {\n  const lines = await readLastLines.read(filePath, n);\n  const to_vanquish = lines.length;\n  const { size } = await fs.stat(filePath);\n  await fs.truncate(filePath, size - to_vanquish);\n}\n\nasync function _saveAssetAsync(projectRoot: string, assets: Asset[], outputDir: string) {\n  // Collect paths by key, also effectively handles duplicates in the array\n  const paths: { [fileHash: string]: string } = {};\n  assets.forEach(asset => {\n    asset.files.forEach((path: string, index: number) => {\n      paths[asset.fileHashes[index]] = path;\n    });\n  });\n\n  // save files one chunk at a time\n  const keyChunks = chunk(Object.keys(paths), 5);\n  for (const keys of keyChunks) {\n    const promises = [];\n    for (const key of keys) {\n      ProjectUtils.logDebug(projectRoot, 'expo', `uploading ${paths[key]}`);\n\n      logger.global.info({ quiet: true }, `Saving ${paths[key]}`);\n\n      let assetPath = path.resolve(outputDir, 'assets', key);\n\n      // copy file over to assetPath\n      const p = fs.copy(paths[key], assetPath);\n      promises.push(p);\n    }\n    await Promise.all(promises);\n  }\n  logger.global.info('Files successfully saved.');\n}\n\nexport async function findReusableBuildAsync(\n  releaseChannel: string,\n  platform: string,\n  sdkVersion: string,\n  slug: string\n): Promise<{ downloadUrl?: string; canReuse: boolean }> {\n  const user = await UserManager.getCurrentUserAsync();\n\n  const buildReuseStatus = await ApiV2.clientForUser(user).postAsync('standalone-build/reuse', {\n    releaseChannel,\n    platform,\n    sdkVersion,\n    slug,\n  });\n\n  return buildReuseStatus;\n}\n\nexport async function publishAsync(\n  projectRoot: string,\n  options: PublishOptions = {}\n): Promise<{ url: string; ids: string[]; err?: string }> {\n  const user = await UserManager.ensureLoggedInAsync();\n  await _validatePackagerReadyAsync(projectRoot);\n  Analytics.logEvent('Publish', {\n    projectRoot,\n    developerTool: Config.developerTool,\n  });\n\n  const validationStatus = await Doctor.validateWithNetworkAsync(projectRoot);\n  if (validationStatus === Doctor.ERROR || validationStatus === Doctor.FATAL) {\n    throw new XDLError(\n      'PUBLISH_VALIDATION_ERROR',\n      \"Couldn't publish because errors were found. (See logs above.) Please fix the errors and try again.\"\n    );\n  }\n\n  // Get project config\n  let { exp, pkg } = await _getPublishExpConfigAsync(projectRoot, options);\n\n  // TODO: refactor this out to a function, throw error if length doesn't match\n  let { hooks } = exp;\n  delete exp.hooks;\n  let validPostPublishHooks: PostPublishHook[] = [];\n  if (hooks && hooks.postPublish) {\n    hooks.postPublish.forEach((hook: any) => {\n      let { file } = hook;\n      let fn = _requireFromProject(file, projectRoot, exp);\n      if (typeof fn !== 'function') {\n        logger.global.error(\n          `Unable to load postPublishHook: '${file}'. The module does not export a function.`\n        );\n      } else {\n        hook._fn = fn;\n        validPostPublishHooks.push(hook);\n      }\n    });\n\n    if (validPostPublishHooks.length !== hooks.postPublish.length) {\n      logger.global.error();\n\n      throw new XDLError(\n        'HOOK_INITIALIZATION_ERROR',\n        'Please fix your postPublish hook configuration.'\n      );\n    }\n  }\n\n  let { iosBundle, androidBundle } = await _buildPublishBundlesAsync(projectRoot);\n\n  await _fetchAndUploadAssetsAsync(projectRoot, exp);\n\n  const hasHooks = validPostPublishHooks.length > 0;\n\n  const shouldPublishAndroidMaps = !!exp.android && !!exp.android.publishSourceMapPath;\n\n  const shouldPublishIosMaps = !!exp.ios && !!exp.ios.publishSourceMapPath;\n\n  let { iosSourceMap, androidSourceMap } = await _maybeBuildSourceMapsAsync(projectRoot, exp, {\n    force: hasHooks || shouldPublishAndroidMaps || shouldPublishIosMaps,\n  });\n\n  let response;\n  try {\n    response = await _uploadArtifactsAsync({\n      pkg,\n      exp,\n      iosBundle,\n      androidBundle,\n      options,\n    });\n  } catch (e) {\n    if (e.serverError === 'SCHEMA_VALIDATION_ERROR') {\n      throw new Error(\n        `There was an error validating your project schema. Check for any warnings about the contents of your app/exp.json.`\n      );\n    }\n    Sentry.captureException(e);\n    throw e;\n  }\n\n  await _maybeWriteArtifactsToDiskAsync({\n    exp,\n    projectRoot,\n    iosBundle,\n    androidBundle,\n    iosSourceMap,\n    androidSourceMap,\n  });\n\n  if (\n    validPostPublishHooks.length ||\n    (exp.ios && exp.ios.publishManifestPath) ||\n    (exp.android && exp.android.publishManifestPath)\n  ) {\n    let [androidManifest, iosManifest] = await Promise.all([\n      ExponentTools.getManifestAsync(response.url, {\n        'Exponent-SDK-Version': exp.sdkVersion,\n        'Exponent-Platform': 'android',\n        'Expo-Release-Channel': options.releaseChannel,\n        Accept: 'application/expo+json,application/json',\n      }),\n      ExponentTools.getManifestAsync(response.url, {\n        'Exponent-SDK-Version': exp.sdkVersion,\n        'Exponent-Platform': 'ios',\n        'Expo-Release-Channel': options.releaseChannel,\n        Accept: 'application/expo+json,application/json',\n      }),\n    ]);\n\n    const hookOptions = {\n      url: response.url,\n      exp,\n      iosBundle,\n      iosSourceMap,\n      iosManifest,\n      androidBundle,\n      androidSourceMap,\n      androidManifest,\n      projectRoot,\n      log: (msg: any) => {\n        logger.global.info({ quiet: true }, msg);\n      },\n    };\n\n    for (let hook of validPostPublishHooks) {\n      logger.global.info(`Running postPublish hook: ${hook.file}`);\n      try {\n        let result = hook._fn({\n          config: hook.config,\n          ...hookOptions,\n        });\n\n        // If it's a promise, wait for it to resolve\n        if (result && result.then) {\n          result = await result;\n        }\n\n        if (result) {\n          logger.global.info({ quiet: true }, result);\n        }\n      } catch (e) {\n        logger.global.warn(`Warning: postPublish hook '${hook.file}' failed: ${e.stack}`);\n      }\n    }\n\n    let fullManifestUrl = response.url.replace('exp://', 'https://');\n\n    if (exp.ios && exp.ios.publishManifestPath) {\n      await _writeArtifactSafelyAsync(\n        projectRoot,\n        'ios.publishManifestPath',\n        exp.ios.publishManifestPath,\n        JSON.stringify(iosManifest)\n      );\n      const context = StandaloneContext.createUserContext(projectRoot, exp);\n      const { supportingDirectory } = IosWorkspace.getPaths(context);\n      if (fs.existsSync(path.join(supportingDirectory, 'EXShell.plist'))) {\n        // This is an ExpoKit app, set properties in EXShell.plist\n        await IosPlist.modifyAsync(supportingDirectory, 'EXShell', (shellPlist: any) => {\n          shellPlist.releaseChannel = options.releaseChannel;\n          return shellPlist;\n        });\n      }\n      if (fs.existsSync(path.join(supportingDirectory, 'Expo.plist'))) {\n        // This is an app with expo-updates installed, set properties in Expo.plist\n        await IosPlist.modifyAsync(supportingDirectory, 'Expo', (configPlist: any) => {\n          configPlist.EXUpdatesURL = fullManifestUrl;\n          configPlist.EXUpdatesReleaseChannel = options.releaseChannel;\n          configPlist.EXUpdatesSDKVersion = exp.sdkVersion;\n          return configPlist;\n        });\n      }\n    }\n\n    if (exp.android && exp.android.publishManifestPath) {\n      await _writeArtifactSafelyAsync(\n        projectRoot,\n        'android.publishManifestPath',\n        exp.android.publishManifestPath,\n        JSON.stringify(androidManifest)\n      );\n    }\n\n    if (exp.android && exp.android.publishManifestPath && exp.android.publishBundlePath) {\n      let constantsPath = path.join(\n        projectRoot,\n        'android',\n        'app',\n        'src',\n        'main',\n        'java',\n        'host',\n        'exp',\n        'exponent',\n        'generated',\n        'AppConstants.java'\n      );\n      if (fs.existsSync(constantsPath)) {\n        // This is an ExpoKit app\n        // We need to add EmbeddedResponse instances on Android to tell the runtime\n        // that the shell app manifest and bundle is packaged.\n        await ExponentTools.deleteLinesInFileAsync(\n          `START EMBEDDED RESPONSES`,\n          `END EMBEDDED RESPONSES`,\n          constantsPath\n        );\n        await ExponentTools.regexFileAsync(\n          '// ADD EMBEDDED RESPONSES HERE',\n          `\n          // ADD EMBEDDED RESPONSES HERE\n          // START EMBEDDED RESPONSES\n          embeddedResponses.add(new Constants.EmbeddedResponse(\"${fullManifestUrl}\", \"assets://shell-app-manifest.json\", \"application/json\"));\n          embeddedResponses.add(new Constants.EmbeddedResponse(\"${androidManifest.bundleUrl}\", \"assets://shell-app.bundle\", \"application/javascript\"));\n          // END EMBEDDED RESPONSES`,\n          constantsPath\n        );\n        await ExponentTools.regexFileAsync(\n          /RELEASE_CHANNEL = \"[^\"]*\"/,\n          `RELEASE_CHANNEL = \"${options.releaseChannel}\"`,\n          constantsPath\n        );\n      }\n      if (pkg.dependencies['expo-updates']) {\n        // This is an app with expo-updates installed, so set the applicable meta-data properties in\n        // AndroidManifest.xml\n        let androidManifestXmlPath = path.join(\n          projectRoot,\n          'android',\n          'app',\n          'src',\n          'main',\n          'AndroidManifest.xml'\n        );\n        let androidManifestXmlFile = fs.readFileSync(androidManifestXmlPath, 'utf8');\n        let expoUpdateUrlRegex = /<meta-data[^>]+\"expo.modules.updates.EXPO_UPDATE_URL\"[^>]+\\/>/;\n        let expoSdkVersionRegex = /<meta-data[^>]+\"expo.modules.updates.EXPO_SDK_VERSION\"[^>]+\\/>/;\n        let expoReleaseChannelRegex = /<meta-data[^>]+\"expo.modules.updates.EXPO_RELEASE_CHANNEL\"[^>]+\\/>/;\n\n        let expoUpdateUrlTag = `<meta-data android:name=\"expo.modules.updates.EXPO_UPDATE_URL\" android:value=\"${fullManifestUrl}\" />`;\n        let expoSdkVersionTag = `<meta-data android:name=\"expo.modules.updates.EXPO_SDK_VERSION\" android:value=\"${exp.sdkVersion}\" />`;\n        let expoReleaseChannelTag = `<meta-data android:name=\"expo.modules.updates.EXPO_RELEASE_CHANNEL\" android:value=\"${options.releaseChannel}\" />`;\n\n        let tagsToInsert = [];\n        if (androidManifestXmlFile.search(expoUpdateUrlRegex) < 0) {\n          tagsToInsert.push(expoUpdateUrlTag);\n        }\n        if (androidManifestXmlFile.search(expoSdkVersionRegex) < 0) {\n          tagsToInsert.push(expoSdkVersionTag);\n        }\n        if (androidManifestXmlFile.search(expoReleaseChannelRegex) < 0) {\n          tagsToInsert.push(expoReleaseChannelTag);\n        }\n        if (tagsToInsert.length) {\n          // try to insert the meta-data tags that aren't found\n          await ExponentTools.regexFileAsync(\n            /<activity\\s+android:name=\".MainActivity\"/,\n            `${tagsToInsert.join('\\n      ')}\n\n      <activity\n        android:name=\".MainActivity\"`,\n            androidManifestXmlPath\n          );\n        }\n        await ExponentTools.regexFileAsync(\n          expoUpdateUrlRegex,\n          expoUpdateUrlTag,\n          androidManifestXmlPath\n        );\n        await ExponentTools.regexFileAsync(\n          expoSdkVersionRegex,\n          expoSdkVersionTag,\n          androidManifestXmlPath\n        );\n        await ExponentTools.regexFileAsync(\n          expoReleaseChannelRegex,\n          expoReleaseChannelTag,\n          androidManifestXmlPath\n        );\n      }\n    }\n  }\n\n  // TODO: move to postPublish hook\n  if (exp.isKernel) {\n    await _handleKernelPublishedAsync({\n      user,\n      exp,\n      projectRoot,\n      url: response.url,\n    });\n  }\n\n  return {\n    ...response,\n    url:\n      options.releaseChannel && options.releaseChannel !== 'default'\n        ? `${response.url}?release-channel=${options.releaseChannel}`\n        : response.url,\n  };\n}\n\nasync function _uploadArtifactsAsync({\n  exp,\n  iosBundle,\n  androidBundle,\n  options,\n  pkg,\n}: {\n  exp: ExpoConfig;\n  iosBundle: string;\n  androidBundle: string;\n  options: PublishOptions;\n  pkg: PackageJSONConfig;\n}) {\n  logger.global.info('Uploading JavaScript bundles');\n  let formData = new FormData();\n\n  formData.append('expJson', JSON.stringify(exp));\n  formData.append('packageJson', JSON.stringify(pkg));\n  formData.append('iosBundle', iosBundle, 'iosBundle');\n  formData.append('androidBundle', androidBundle, 'androidBundle');\n  formData.append('options', JSON.stringify(options));\n\n  let response: any;\n  if (process.env.EXPO_LEGACY_API === 'true') {\n    response = await Api.callMethodAsync('publish', null, 'put', null, { formData });\n  } else {\n    const user = await UserManager.ensureLoggedInAsync();\n    const api = ApiV2.clientForUser(user);\n    response = await api.uploadFormDataAsync('publish/new', formData);\n  }\n  return response;\n}\n\nasync function _validatePackagerReadyAsync(projectRoot: string) {\n  _assertValidProjectRoot(projectRoot);\n\n  // Ensure the packager is started\n  let packagerInfo = await ProjectSettings.readPackagerInfoAsync(projectRoot);\n  if (!packagerInfo.packagerPort) {\n    ProjectUtils.logWarning(\n      projectRoot,\n      'expo',\n      'Metro Bundler is not running. Trying to restart it...'\n    );\n    await startReactNativeServerAsync(projectRoot, { reset: true });\n  }\n}\n\nasync function _getPublishExpConfigAsync(\n  projectRoot: string,\n  options: PublishOptions\n): Promise<{\n  exp: PublicConfig;\n  pkg: PackageJSONConfig;\n}> {\n  let schema = joi.object().keys({\n    releaseChannel: joi.string(),\n  });\n\n  // Validate schema\n  const { error } = joi.validate(options, schema);\n  if (error) {\n    throw new XDLError('INVALID_OPTIONS', error.toString());\n  }\n  options.releaseChannel = options.releaseChannel || 'default'; // joi default not enforcing this :/\n\n  // Verify that exp/app.json and package.json exist\n  const { exp, pkg } = getConfig(projectRoot);\n\n  if (exp.android && exp.android.config) {\n    delete exp.android.config;\n  }\n\n  if (exp.ios && exp.ios.config) {\n    delete exp.ios.config;\n  }\n\n  const { sdkVersion } = exp;\n\n  // Only allow projects to be published with UNVERSIONED if a correct token is set in env\n  if (sdkVersion === 'UNVERSIONED' && !maySkipManifestValidation()) {\n    throw new XDLError('INVALID_OPTIONS', 'Cannot publish with sdkVersion UNVERSIONED.');\n  }\n  exp.locales = await ExponentTools.getResolvedLocalesAsync(exp);\n  return { exp: { ...exp, sdkVersion: sdkVersion! }, pkg };\n}\n\n// Fetch iOS and Android bundles for publishing\nasync function _buildPublishBundlesAsync(projectRoot: string, opts?: PackagerOptions) {\n  const entryPoint = Exp.determineEntryPoint(projectRoot);\n  const publishUrl = await UrlUtils.constructPublishUrlAsync(\n    projectRoot,\n    entryPoint,\n    undefined,\n    opts\n  );\n\n  logger.global.info('Building iOS bundle');\n  const iosBundle = await _getForPlatformAsync(projectRoot, publishUrl, 'ios', {\n    errorCode: 'INVALID_BUNDLE',\n    minLength: MINIMUM_BUNDLE_SIZE,\n  });\n\n  logger.global.info('Building Android bundle');\n  const androidBundle = await _getForPlatformAsync(projectRoot, publishUrl, 'android', {\n    errorCode: 'INVALID_BUNDLE',\n    minLength: MINIMUM_BUNDLE_SIZE,\n  });\n\n  return { iosBundle, androidBundle };\n}\n\nasync function _maybeBuildSourceMapsAsync(\n  projectRoot: string,\n  exp: ExpoConfig,\n  options = { force: false }\n) {\n  if (options.force) {\n    return _buildSourceMapsAsync(projectRoot, exp);\n  } else {\n    return { iosSourceMap: null, androidSourceMap: null };\n  }\n}\n\n// note(brentvatne): currently we build source map anytime there is a\n// postPublish hook -- we may have an option in the future to manually\n// enable sourcemap building, but for now it's very fast, most apps in\n// production should use sourcemaps for error reporting, and in the worst\n// case, adding a few seconds to a postPublish hook isn't too annoying\nasync function _buildSourceMapsAsync(projectRoot: string, exp: ExpoConfig) {\n  let entryPoint = Exp.determineEntryPoint(projectRoot);\n  let sourceMapUrl = await UrlUtils.constructSourceMapUrlAsync(projectRoot, entryPoint);\n\n  logger.global.info('Building sourcemaps');\n  let iosSourceMap = await _getForPlatformAsync(projectRoot, sourceMapUrl, 'ios', {\n    errorCode: 'INVALID_BUNDLE',\n    minLength: MINIMUM_BUNDLE_SIZE,\n  });\n\n  let androidSourceMap = await _getForPlatformAsync(projectRoot, sourceMapUrl, 'android', {\n    errorCode: 'INVALID_BUNDLE',\n    minLength: MINIMUM_BUNDLE_SIZE,\n  });\n\n  return { iosSourceMap, androidSourceMap };\n}\n\n/**\n * Collects all the assets declared in the android app, ios app and manifest\n *\n * @param {string} hostedAssetPrefix\n *    The path where assets are hosted (ie) http://xxx.cloudfront.com/assets/\n *\n * @modifies {exp} Replaces relative asset paths in the manifest with hosted URLS\n *\n */\nasync function _collectAssets(\n  projectRoot: string,\n  exp: PublicConfig,\n  hostedAssetPrefix: string\n): Promise<Asset[]> {\n  let entryPoint = Exp.determineEntryPoint(projectRoot);\n  let assetsUrl = await UrlUtils.constructAssetsUrlAsync(projectRoot, entryPoint);\n\n  let iosAssetsJson = await _getForPlatformAsync(projectRoot, assetsUrl, 'ios', {\n    errorCode: 'INVALID_ASSETS',\n  });\n\n  let androidAssetsJson = await _getForPlatformAsync(projectRoot, assetsUrl, 'android', {\n    errorCode: 'INVALID_ASSETS',\n  });\n\n  // Resolve manifest assets to their hosted URL and add them to the list of assets to\n  // be uploaded. Modifies exp.\n  const manifestAssets: Asset[] = [];\n  await _resolveManifestAssets(\n    projectRoot,\n    exp,\n    async (assetPath: string) => {\n      const absolutePath = path.resolve(projectRoot, assetPath);\n      const contents = await fs.readFile(absolutePath);\n      const hash = md5hex(contents);\n      manifestAssets.push({ files: [absolutePath], fileHashes: [hash], hash });\n      return urljoin(hostedAssetPrefix, hash);\n    },\n    true\n  );\n\n  // Upload asset files\n  const iosAssets = JSON.parse(iosAssetsJson);\n  const androidAssets = JSON.parse(androidAssetsJson);\n  return iosAssets.concat(androidAssets).concat(manifestAssets);\n}\n\n/**\n * Configures exp, preparing it for asset export\n *\n * @modifies {exp}\n *\n */\nasync function _configureExpForAssets(projectRoot: string, exp: ExpoConfig, assets: Asset[]) {\n  // Add google services file if it exists\n  await _resolveGoogleServicesFile(projectRoot, exp);\n\n  // Convert asset patterns to a list of asset strings that match them.\n  // Assets strings are formatted as `asset_<hash>.<type>` and represent\n  // the name that the file will have in the app bundle. The `asset_` prefix is\n  // needed because android doesn't support assets that start with numbers.\n  if (exp.assetBundlePatterns) {\n    const fullPatterns: string[] = exp.assetBundlePatterns.map((p: string) =>\n      path.join(projectRoot, p)\n    );\n    logger.global.info('Processing asset bundle patterns:');\n    fullPatterns.forEach(p => logger.global.info('- ' + p));\n    // The assets returned by the RN packager has duplicates so make sure we\n    // only bundle each once.\n    const bundledAssets = new Set();\n    for (const asset of assets) {\n      const file = asset.files && asset.files[0];\n      const shouldBundle =\n        '__packager_asset' in asset &&\n        asset.__packager_asset &&\n        file &&\n        fullPatterns.some((p: string) => minimatch(file, p));\n      ProjectUtils.logDebug(\n        projectRoot,\n        'expo',\n        `${shouldBundle ? 'Include' : 'Exclude'} asset ${file}`\n      );\n      if (shouldBundle) {\n        asset.fileHashes.forEach(hash =>\n          bundledAssets.add(\n            'asset_' + hash + ('type' in asset && asset.type ? '.' + asset.type : '')\n          )\n        );\n      }\n    }\n    exp.bundledAssets = [...bundledAssets];\n    delete exp.assetBundlePatterns;\n  }\n\n  return exp;\n}\n\nasync function _fetchAndUploadAssetsAsync(projectRoot: string, exp: PublicConfig) {\n  logger.global.info('Analyzing assets');\n\n  const assetCdnPath = urljoin(EXPO_CDN, '~assets');\n  const assets = await _collectAssets(projectRoot, exp, assetCdnPath);\n\n  logger.global.info('Uploading assets');\n\n  if (assets.length > 0 && assets[0].fileHashes) {\n    await uploadAssetsAsync(projectRoot, assets);\n  } else {\n    logger.global.info({ quiet: true }, 'No assets to upload, skipped.');\n  }\n\n  // Updates the manifest to reflect additional asset bundling + configs\n  await _configureExpForAssets(projectRoot, exp, assets);\n\n  return exp;\n}\n\nasync function _fetchAndSaveAssetsAsync(\n  projectRoot: string,\n  exp: PublicConfig,\n  hostedUrl: string,\n  outputDir: string\n) {\n  logger.global.info('Analyzing assets');\n\n  const assetCdnPath = urljoin(hostedUrl, 'assets');\n  const assets = await _collectAssets(projectRoot, exp, assetCdnPath);\n\n  logger.global.info('Saving assets');\n\n  if (assets.length > 0 && assets[0].fileHashes) {\n    await _saveAssetAsync(projectRoot, assets, outputDir);\n  } else {\n    logger.global.info({ quiet: true }, 'No assets to upload, skipped.');\n  }\n\n  // Updates the manifest to reflect additional asset bundling + configs\n  await _configureExpForAssets(projectRoot, exp, assets);\n\n  return { exp, assets };\n}\n\nasync function _writeArtifactSafelyAsync(\n  projectRoot: string,\n  keyName: string | null,\n  artifactPath: string,\n  artifact: string\n) {\n  const pathToWrite = path.resolve(projectRoot, artifactPath);\n  if (!fs.existsSync(path.dirname(pathToWrite))) {\n    const errorMsg = keyName\n      ? `app.json specifies: ${pathToWrite}, but that directory does not exist.`\n      : `app.json specifies ${keyName}: ${pathToWrite}, but that directory does not exist.`;\n    logger.global.warn(errorMsg);\n  } else {\n    await fs.writeFile(pathToWrite, artifact);\n  }\n}\n\nasync function _maybeWriteArtifactsToDiskAsync({\n  exp,\n  projectRoot,\n  iosBundle,\n  androidBundle,\n  iosSourceMap,\n  androidSourceMap,\n}: {\n  exp: ExpoConfig;\n  projectRoot: string;\n  iosBundle: string;\n  androidBundle: string;\n  iosSourceMap: string | null;\n  androidSourceMap: string | null;\n}) {\n  if (exp.android && exp.android.publishBundlePath) {\n    await _writeArtifactSafelyAsync(\n      projectRoot,\n      'android.publishBundlePath',\n      exp.android.publishBundlePath,\n      androidBundle\n    );\n  }\n\n  if (exp.ios && exp.ios.publishBundlePath) {\n    await _writeArtifactSafelyAsync(\n      projectRoot,\n      'ios.publishBundlePath',\n      exp.ios.publishBundlePath,\n      iosBundle\n    );\n  }\n\n  if (exp.android && exp.android.publishSourceMapPath && androidSourceMap) {\n    await _writeArtifactSafelyAsync(\n      projectRoot,\n      'android.publishSourceMapPath',\n      exp.android.publishSourceMapPath,\n      androidSourceMap\n    );\n  }\n\n  if (exp.ios && exp.ios.publishSourceMapPath && iosSourceMap) {\n    await _writeArtifactSafelyAsync(\n      projectRoot,\n      'ios.publishSourceMapPath',\n      exp.ios.publishSourceMapPath,\n      iosSourceMap\n    );\n  }\n}\n\nasync function _handleKernelPublishedAsync({\n  projectRoot,\n  user,\n  exp,\n  url,\n}: {\n  projectRoot: string;\n  user: User;\n  exp: ExpoConfig;\n  url: string;\n}) {\n  let kernelBundleUrl = `${Config.api.scheme}://${Config.api.host}`;\n  if (Config.api.port) {\n    kernelBundleUrl = `${kernelBundleUrl}:${Config.api.port}`;\n  }\n  kernelBundleUrl = `${kernelBundleUrl}/@${user.username}/${exp.slug}/bundle`;\n\n  if (exp.kernel.androidManifestPath) {\n    let manifest = await ExponentTools.getManifestAsync(url, {\n      'Exponent-SDK-Version': exp.sdkVersion,\n      'Exponent-Platform': 'android',\n      Accept: 'application/expo+json,application/json',\n    });\n    manifest.bundleUrl = kernelBundleUrl;\n    manifest.sdkVersion = 'UNVERSIONED';\n    await fs.writeFile(\n      path.resolve(projectRoot, exp.kernel.androidManifestPath),\n      JSON.stringify(manifest)\n    );\n  }\n\n  if (exp.kernel.iosManifestPath) {\n    let manifest = await ExponentTools.getManifestAsync(url, {\n      'Exponent-SDK-Version': exp.sdkVersion,\n      'Exponent-Platform': 'ios',\n      Accept: 'application/expo+json,application/json',\n    });\n    manifest.bundleUrl = kernelBundleUrl;\n    manifest.sdkVersion = 'UNVERSIONED';\n    await fs.writeFile(\n      path.resolve(projectRoot, exp.kernel.iosManifestPath),\n      JSON.stringify(manifest)\n    );\n  }\n}\n\n// TODO(jesse): Add analytics for upload\nasync function uploadAssetsAsync(projectRoot: string, assets: Asset[]) {\n  // Collect paths by key, also effectively handles duplicates in the array\n  const paths: { [fileHash: string]: string } = {};\n  assets.forEach(asset => {\n    asset.files.forEach((path: string, index: number) => {\n      paths[asset.fileHashes[index]] = path;\n    });\n  });\n\n  // Collect list of assets missing on host\n  let result;\n  if (process.env.EXPO_LEGACY_API === 'true') {\n    result = await Api.callMethodAsync('assetsMetadata', [], 'post', { keys: Object.keys(paths) });\n  } else {\n    const user = await UserManager.ensureLoggedInAsync();\n    const api = ApiV2.clientForUser(user);\n    result = await api.postAsync('assets/metadata', { keys: Object.keys(paths) });\n  }\n  const metas = result.metadata;\n  const missing = Object.keys(paths).filter(key => !metas[key].exists);\n\n  if (missing.length === 0) {\n    logger.global.info({ quiet: true }, `No assets changed, skipped.`);\n  }\n\n  // Upload them!\n  await Promise.all(\n    chunk(missing, 5).map(async keys => {\n      let formData = new FormData();\n      for (const key of keys) {\n        ProjectUtils.logDebug(projectRoot, 'expo', `uploading ${paths[key]}`);\n\n        let relativePath = paths[key].replace(projectRoot, '');\n        logger.global.info({ quiet: true }, `Uploading ${relativePath}`);\n\n        formData.append(key, fs.createReadStream(paths[key]), paths[key]);\n      }\n\n      if (process.env.EXPO_LEGACY_API === 'true') {\n        await Api.callMethodAsync('uploadAssets', [], 'put', null, { formData });\n      } else {\n        const user = await UserManager.ensureLoggedInAsync();\n        const api = ApiV2.clientForUser(user);\n        await api.uploadFormDataAsync('assets/upload', formData);\n      }\n    })\n  );\n}\n\ntype GetExpConfigOptions = {\n  current?: boolean;\n  mode?: string;\n  platform?: 'android' | 'ios' | 'all';\n  expIds?: string[];\n  type?: string;\n  releaseChannel?: string;\n  bundleIdentifier?: string;\n  publicUrl?: string;\n  sdkVersion?: string;\n};\n\nasync function getConfigAsync(\n  projectRoot: string,\n  options: Pick<GetExpConfigOptions, 'publicUrl' | 'platform'> = {}\n) {\n  if (!options.publicUrl) {\n    // get the manifest from the project directory\n    const { exp, pkg } = getConfig(projectRoot);\n    const configName = configFilename(projectRoot);\n    return {\n      exp,\n      pkg,\n      configName: configFilename(projectRoot),\n      configPrefix: configName === 'app.json' ? 'expo.' : '',\n    };\n  } else {\n    // get the externally hosted manifest\n    return {\n      exp: await ThirdParty.getManifest(options.publicUrl, options),\n      configName: options.publicUrl,\n      configPrefix: '',\n      pkg: {},\n    };\n  }\n}\n\n// TODO(ville): add the full type\ntype BuildJob = unknown;\n\nexport type BuildStatusResult = {\n  jobs: BuildJob[];\n  err: null;\n  userHasBuiltAppBefore: boolean;\n  userHasBuiltExperienceBefore: boolean;\n  canPurchasePriorityBuilds: boolean;\n  numberOfRemainingPriorityBuilds: number;\n  hasUnlimitedPriorityBuilds: boolean;\n};\n\nexport type BuildCreatedResult = {\n  id: string;\n  ids: string[];\n  priority: 'normal' | 'high';\n  canPurchasePriorityBuilds: boolean;\n  numberOfRemainingPriorityBuilds: number;\n  hasUnlimitedPriorityBuilds: boolean;\n};\n\nfunction _validateManifest(options: any, exp: any, configName: string, configPrefix: string) {\n  if (options.platform === 'ios' || options.platform === 'all') {\n    if (!exp.ios || !exp.ios.bundleIdentifier) {\n      throw new XDLError(\n        'INVALID_MANIFEST',\n        `Must specify a bundle identifier in order to build this experience for iOS. ` +\n          `Please specify one in ${configName} at \"${configPrefix}ios.bundleIdentifier\"`\n      );\n    }\n  }\n\n  if (options.platform === 'android' || options.platform === 'all') {\n    if (!exp.android || !exp.android.package) {\n      throw new XDLError(\n        'INVALID_MANIFEST',\n        `Must specify a java package in order to build this experience for Android. ` +\n          `Please specify one in ${configName} at \"${configPrefix}android.package\"`\n      );\n    }\n  }\n}\nfunction _validateOptions(options: any) {\n  const schema = joi.object().keys({\n    current: joi.boolean(),\n    mode: joi.string(),\n    platform: joi.any().valid('ios', 'android', 'all'),\n    expIds: joi.array(),\n    type: joi.any().valid('archive', 'simulator', 'client', 'app-bundle', 'apk'),\n    releaseChannel: joi.string().regex(/[a-z\\d][a-z\\d._-]*/),\n    bundleIdentifier: joi.string().regex(/^[a-zA-Z][a-zA-Z0-9\\-.]+$/),\n    publicUrl: joi.string(),\n    sdkVersion: joi.strict(),\n  });\n\n  const { error } = joi.validate(options, schema);\n  if (error) {\n    throw new XDLError('INVALID_OPTIONS', error.toString());\n  }\n}\n\nasync function _getExpAsync(\n  projectRoot: string,\n  options: Pick<GetExpConfigOptions, 'publicUrl' | 'mode' | 'platform'>\n) {\n  const { exp, pkg, configName, configPrefix } = await getConfigAsync(projectRoot, options);\n\n  if (!exp || !pkg) {\n    throw new XDLError(\n      'NO_PACKAGE_JSON',\n      `Couldn't read ${configName} file in project at ${projectRoot}`\n    );\n  }\n\n  // Support version and name being specified in package.json for legacy\n  // support pre: exp.json\n  if (!exp.version && 'version' in pkg && pkg.version) {\n    exp.version = pkg.version;\n  }\n  if (!exp.name && 'name' in pkg && typeof pkg.name === 'string') {\n    exp.name = pkg.name;\n  }\n  if (!exp.slug && typeof exp.name === 'string') {\n    exp.slug = slug(exp.name.toLowerCase());\n  }\n  return { exp, configName, configPrefix };\n}\n\nexport async function getBuildStatusAsync(\n  projectRoot: string,\n  options: GetExpConfigOptions = {}\n): Promise<BuildStatusResult> {\n  const user = await UserManager.ensureLoggedInAsync();\n\n  _assertValidProjectRoot(projectRoot);\n  _validateOptions(options);\n  const { exp } = await _getExpAsync(projectRoot, options);\n\n  const api = ApiV2.clientForUser(user);\n  return await api.postAsync('build/status', { manifest: exp, options });\n}\n\nexport async function startBuildAsync(\n  projectRoot: string,\n  options: GetExpConfigOptions = {}\n): Promise<BuildCreatedResult> {\n  const user = await UserManager.ensureLoggedInAsync();\n\n  _assertValidProjectRoot(projectRoot);\n  _validateOptions(options);\n  const { exp, configName, configPrefix } = await _getExpAsync(projectRoot, options);\n  _validateManifest(options, exp, configName, configPrefix);\n\n  Analytics.logEvent('Build Shell App', {\n    projectRoot,\n    developerTool: Config.developerTool,\n    platform: options.platform,\n  });\n\n  const api = ApiV2.clientForUser(user);\n  return await api.putAsync('build/start', { manifest: exp, options });\n}\n\nexport async function buildAsync(\n  projectRoot: string,\n  options: GetExpConfigOptions = {}\n): Promise<BuildStatusResult | BuildCreatedResult> {\n  /**\n    This function corresponds to an apiv1 call and is deprecated.\n    Use \n      * startBuildAsync\n      * getBuildStatusAsync\n    to call apiv2 instead.\n   */\n  await UserManager.ensureLoggedInAsync();\n  _assertValidProjectRoot(projectRoot);\n\n  Analytics.logEvent('Build Shell App', {\n    projectRoot,\n    developerTool: Config.developerTool,\n    platform: options.platform,\n  });\n\n  _validateOptions(options);\n  const { exp, configName, configPrefix } = await _getExpAsync(projectRoot, options);\n  if (options.mode === 'create') {\n    _validateManifest(options, exp, configName, configPrefix);\n  }\n\n  return await Api.callMethodAsync('build', [], 'put', { manifest: exp, options });\n}\n\nasync function _waitForRunningAsync(\n  projectRoot: string,\n  url: string,\n  retries: number = 300\n): Promise<true> {\n  try {\n    let response = await axios.get(url, {\n      responseType: 'text',\n      proxy: false,\n    });\n    if (/packager-status:running/.test(response.data)) {\n      return true;\n    } else if (retries === 0) {\n      ProjectUtils.logError(\n        projectRoot,\n        'expo',\n        `Could not get status from Metro bundler. Server response: ${response.data}`\n      );\n    }\n  } catch (e) {\n    if (retries === 0) {\n      ProjectUtils.logError(\n        projectRoot,\n        'expo',\n        `Could not get status from Metro bundler. ${e.message}`\n      );\n    }\n  }\n\n  if (retries <= 0) {\n    throw new Error('Connecting to Metro bundler failed.');\n  } else {\n    await delayAsync(100);\n    return _waitForRunningAsync(projectRoot, url, retries - 1);\n  }\n}\n\n// The --verbose flag is intended for react-native-cli/metro, not expo-cli\nconst METRO_VERBOSE_WARNING = 'Run CLI with --verbose flag for more details.';\n\n// Remove these constants and related code when SDK35 isn't supported anymore\n// Context: https://github.com/expo/expo-cli/issues/1074\nconst NODE_12_WINDOWS_METRO_ERROR = `Invalid regular expression: /(.*\\\\__fixtures__\\\\.*|node_modules[\\\\\\]react[\\\\\\]dist[\\\\\\].*|website\\\\node_modules\\\\.*|heapCapture\\\\bundle\\.js|.*\\\\__tests__\\\\.*)$/: Unterminated character class`;\nconst NODE_12_WINDOWS_METRO_SUGGESTION = `\\nUnable to start the project due to a documented incompatibility between Node 12 LTS and Expo SDK 35 on Windows.\nPlease refer to this GitHub comment for a solution:\nhttps://github.com/expo/expo-cli/issues/1074#issuecomment-559220752\\n`;\n\nfunction _logPackagerOutput(projectRoot: string, level: string, data: object) {\n  let output = data.toString();\n  if (!output) {\n    return;\n  }\n  // Temporarily hide warnings about duplicate providesModule declarations\n  // under react-native\n  if (_isIgnorableDuplicateModuleWarning(projectRoot, level, output)) {\n    ProjectUtils.logDebug(\n      projectRoot,\n      'expo',\n      `Suppressing @providesModule warning: ${output}`,\n      'project-suppress-providesmodule-warning'\n    );\n    return;\n  }\n  if (_isIgnorableMetroConsoleOutput(output) || _isIgnorableRnpmWarning(output)) {\n    ProjectUtils.logDebug(projectRoot, 'expo', output);\n    return;\n  }\n\n  if (output.includes(NODE_12_WINDOWS_METRO_ERROR)) {\n    ProjectUtils.logError(projectRoot, 'expo', NODE_12_WINDOWS_METRO_SUGGESTION);\n    return;\n  }\n\n  if (output.includes(METRO_VERBOSE_WARNING)) {\n    output = output.replace(METRO_VERBOSE_WARNING, '');\n  }\n\n  if (/^Scanning folders for symlinks in /.test(output)) {\n    ProjectUtils.logDebug(projectRoot, 'metro', output);\n    return;\n  }\n  if (level === 'info') {\n    ProjectUtils.logInfo(projectRoot, 'metro', output);\n  } else {\n    ProjectUtils.logError(projectRoot, 'metro', output);\n  }\n}\n\nfunction _isIgnorableMetroConsoleOutput(output: string) {\n  // As of React Native 0.61.x, Metro prints console logs from the device to console, without\n  // passing them through the custom log reporter.\n  //\n  // Managed apps have a separate remote logging implementation included in the Expo SDK,\n  // (see: _handleDeviceLogs), so we can just ignore these device logs from Metro.\n  // if (/^ () /)\n  //\n  // These logs originate from:\n  // https://github.com/facebook/metro/blob/e8181fb9db7db31adf7d1ed9ab840f54449ef238/packages/metro/src/lib/logToConsole.js#L50\n  return /^\\s+(INFO|WARN|LOG|GROUP|DEBUG) /.test(output);\n}\n\nfunction _isIgnorableRnpmWarning(output: string) {\n  return output.startsWith(\n    'warn The following packages use deprecated \"rnpm\" config that will stop working from next release'\n  );\n}\n\nfunction _isIgnorableDuplicateModuleWarning(\n  projectRoot: string,\n  level: string,\n  output: string\n): boolean {\n  if (\n    level !== 'error' ||\n    !output.startsWith('jest-haste-map: @providesModule naming collision:')\n  ) {\n    return false;\n  }\n\n  let reactNativeNodeModulesPath = path.join(\n    projectRoot,\n    'node_modules',\n    'react-native',\n    'node_modules'\n  );\n  let reactNativeNodeModulesPattern = escapeRegExp(reactNativeNodeModulesPath);\n  let reactNativeNodeModulesCollisionRegex = new RegExp(\n    `Paths: ${reactNativeNodeModulesPattern}.+ collides with ${reactNativeNodeModulesPattern}.+`\n  );\n  return reactNativeNodeModulesCollisionRegex.test(output);\n}\n\nfunction _isIgnorableBugReportingExtraData(body: any[]) {\n  return body.length === 2 && body[0] === 'BugReporting extraData:';\n}\n\nfunction _isAppRegistryStartupMessage(body: any[]) {\n  return (\n    body.length === 1 &&\n    (/^Running application \"main\" with appParams:/.test(body[0]) ||\n      /^Running \"main\" with \\{/.test(body[0]))\n  );\n}\n\nfunction _handleDeviceLogs(projectRoot: string, deviceId: string, deviceName: string, logs: any) {\n  for (let i = 0; i < logs.length; i++) {\n    let log = logs[i];\n    let body = typeof log.body === 'string' ? [log.body] : log.body;\n    let { level } = log;\n\n    if (_isIgnorableBugReportingExtraData(body)) {\n      level = logger.DEBUG;\n    }\n    if (_isAppRegistryStartupMessage(body)) {\n      body = [`Running application on ${deviceName}.`];\n    }\n\n    let string = body\n      .map((obj: any) => {\n        if (typeof obj === 'undefined') {\n          return 'undefined';\n        }\n        if (obj === 'null') {\n          return 'null';\n        }\n        if (typeof obj === 'string' || typeof obj === 'number' || typeof obj === 'boolean') {\n          return obj;\n        }\n        try {\n          return JSON.stringify(obj);\n        } catch (e) {\n          return obj.toString();\n        }\n      })\n      .join(' ');\n\n    ProjectUtils.logWithLevel(\n      projectRoot,\n      level,\n      {\n        tag: 'device',\n        deviceId,\n        deviceName,\n        groupDepth: log.groupDepth,\n        shouldHide: log.shouldHide,\n        includesStack: log.includesStack,\n      },\n      string\n    );\n  }\n}\nexport async function startReactNativeServerAsync(\n  projectRoot: string,\n  options: StartOptions = {},\n  verbose: boolean = true\n): Promise<void> {\n  _assertValidProjectRoot(projectRoot);\n  await stopReactNativeServerAsync(projectRoot);\n  await Watchman.addToPathAsync(); // Attempt to fix watchman if it's hanging\n  await Watchman.unblockAndGetVersionAsync(projectRoot);\n\n  let { exp } = getConfig(projectRoot);\n\n  let packagerPort = await _getFreePortAsync(19001); // Create packager options\n\n  const customLogReporterPath: string = require.resolve(path.join(__dirname, 'reporter'));\n\n  // TODO: Bacon: Support .mjs (short-lived JS modules extension that some packages use)\n  const sourceExtsConfig = { isTS: true, isReact: true, isModern: false };\n  const sourceExts =\n    options.target === 'bare'\n      ? getBareExtensions([], sourceExtsConfig)\n      : getManagedExtensions([], sourceExtsConfig);\n\n  let packagerOpts: { [key: string]: any } = {\n    port: packagerPort,\n    customLogReporterPath,\n    sourceExts,\n  };\n\n  if (options.nonPersistent && Versions.lteSdkVersion(exp, '32.0.0')) {\n    packagerOpts.nonPersistent = true;\n  }\n\n  if (Versions.gteSdkVersion(exp, '33.0.0')) {\n    // starting with SDK 37, we bundle this plugin with the expo-asset package instead of expo,\n    // so check there first and fall back to expo if we can't find it in expo-asset\n    try {\n      packagerOpts.assetPlugins = resolveModule(\n        'expo-asset/tools/hashAssetFiles',\n        projectRoot,\n        exp\n      );\n    } catch (e) {\n      packagerOpts.assetPlugins = resolveModule('expo/tools/hashAssetFiles', projectRoot, exp);\n    }\n  }\n\n  if (options.maxWorkers) {\n    packagerOpts['max-workers'] = options.maxWorkers;\n  }\n\n  if (!Versions.gteSdkVersion(exp, '16.0.0')) {\n    delete packagerOpts.customLogReporterPath;\n  }\n  const userPackagerOpts = exp.packagerOpts;\n  if (userPackagerOpts) {\n    // The RN CLI expects rn-cli.config.js's path to be absolute. We use the\n    // project root to resolve relative paths since that was the original\n    // behavior of the RN CLI.\n    if (userPackagerOpts.config) {\n      userPackagerOpts.config = path.resolve(projectRoot, userPackagerOpts.config);\n    }\n\n    packagerOpts = {\n      ...packagerOpts,\n      ...userPackagerOpts,\n    };\n\n    if (userPackagerOpts.port !== undefined && userPackagerOpts.port !== null) {\n      packagerPort = userPackagerOpts.port;\n    }\n  }\n  let cliOpts = reduce(\n    packagerOpts,\n    (opts, val, key) => {\n      // If the packager opt value is boolean, don't set\n      // --[opt] [value], just set '--opt'\n      if (val && typeof val === 'boolean') {\n        opts.push(`--${key}`);\n      } else if (val) {\n        opts.push(`--${key}`, val);\n      }\n      return opts;\n    },\n    ['start']\n  );\n\n  if (process.env.EXPO_DEBUG) {\n    cliOpts.push('--verbose');\n  }\n\n  if (options.reset) {\n    cliOpts.push('--reset-cache');\n  } // Get custom CLI path from project package.json, but fall back to node_module path\n  let defaultCliPath = resolveModule('react-native/local-cli/cli.js', projectRoot, exp);\n  const cliPath = exp.rnCliPath || defaultCliPath;\n  let nodePath;\n  // When using a custom path for the RN CLI, we want it to use the project\n  // root to look up config files and Node modules\n  if (exp.rnCliPath) {\n    nodePath = _nodePathForProjectRoot(projectRoot);\n  } else {\n    nodePath = null;\n  }\n  // Run the copy of Node that's embedded in Electron by setting the\n  // ELECTRON_RUN_AS_NODE environment variable\n  // Note: the CLI script sets up graceful-fs and sets ulimit to 4096 in the\n  // child process\n  const nodePathEnv = nodePath ? { NODE_PATH: nodePath } : {};\n  let packagerProcess = child_process.fork(cliPath, cliOpts, {\n    cwd: projectRoot,\n    env: {\n      ...process.env,\n      REACT_NATIVE_APP_ROOT: projectRoot,\n      ELECTRON_RUN_AS_NODE: '1',\n      ...nodePathEnv,\n    },\n    silent: true,\n  });\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    packagerPort,\n    packagerPid: packagerProcess.pid,\n  }); // TODO: do we need this? don't know if it's ever called\n  process.on('exit', () => {\n    treekill(packagerProcess.pid);\n  });\n  if (!packagerProcess.stdout) {\n    throw new Error('Expected spawned process to have a stdout stream, but none was found.');\n  }\n  if (!packagerProcess.stderr) {\n    throw new Error('Expected spawned process to have a stderr stream, but none was found.');\n  }\n  packagerProcess.stdout.setEncoding('utf8');\n  packagerProcess.stderr.setEncoding('utf8');\n  packagerProcess.stdout.pipe(split()).on('data', data => {\n    if (verbose) {\n      _logPackagerOutput(projectRoot, 'info', data);\n    }\n  });\n  packagerProcess.stderr.on('data', data => {\n    if (verbose) {\n      _logPackagerOutput(projectRoot, 'error', data);\n    }\n  });\n  let exitPromise = new Promise((resolve, reject) => {\n    packagerProcess.once('exit', async code => {\n      ProjectUtils.logDebug(projectRoot, 'expo', `Metro Bundler process exited with code ${code}`);\n      if (code) {\n        reject(new Error(`Metro Bundler process exited with code ${code}`));\n      } else {\n        resolve();\n      }\n      try {\n        await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n          packagerPort: null,\n          packagerPid: null,\n        });\n      } catch (e) {}\n    });\n  });\n  let packagerUrl = await UrlUtils.constructBundleUrlAsync(projectRoot, {\n    urlType: 'http',\n    hostType: 'localhost',\n  });\n  await Promise.race([_waitForRunningAsync(projectRoot, `${packagerUrl}/status`), exitPromise]);\n}\n\n// Simulate the node_modules resolution\n// If you project dir is /Jesse/Expo/Universe/BubbleBounce, returns\n// \"/Jesse/node_modules:/Jesse/Expo/node_modules:/Jesse/Expo/Universe/node_modules:/Jesse/Expo/Universe/BubbleBounce/node_modules\"\nfunction _nodePathForProjectRoot(projectRoot: string): string {\n  let paths = [];\n  let directory = path.resolve(projectRoot);\n  while (true) {\n    paths.push(path.join(directory, 'node_modules'));\n    let parentDirectory = path.dirname(directory);\n    if (directory === parentDirectory) {\n      break;\n    }\n    directory = parentDirectory;\n  }\n  return paths.join(path.delimiter);\n}\nexport async function stopReactNativeServerAsync(projectRoot: string): Promise<void> {\n  _assertValidProjectRoot(projectRoot);\n  let packagerInfo = await ProjectSettings.readPackagerInfoAsync(projectRoot);\n  if (!packagerInfo.packagerPort || !packagerInfo.packagerPid) {\n    ProjectUtils.logDebug(projectRoot, 'expo', `No packager found for project at ${projectRoot}.`);\n    return;\n  }\n  ProjectUtils.logDebug(\n    projectRoot,\n    'expo',\n    `Killing packager process tree: ${packagerInfo.packagerPid}`\n  );\n  try {\n    await treekillAsync(packagerInfo.packagerPid, 'SIGKILL');\n  } catch (e) {\n    ProjectUtils.logDebug(projectRoot, 'expo', `Error stopping packager process: ${e.toString()}`);\n  }\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    packagerPort: null,\n    packagerPid: null,\n  });\n}\n\nlet blacklistedEnvironmentVariables = new Set([\n  'EXPO_APPLE_PASSWORD',\n  'EXPO_ANDROID_KEY_PASSWORD',\n  'EXPO_ANDROID_KEYSTORE_PASSWORD',\n  'EXPO_IOS_DIST_P12_PASSWORD',\n  'EXPO_IOS_PUSH_P12_PASSWORD',\n  'EXPO_CLI_PASSWORD',\n]);\n\nfunction shouldExposeEnvironmentVariableInManifest(key: string) {\n  if (blacklistedEnvironmentVariables.has(key.toUpperCase())) {\n    return false;\n  }\n  return key.startsWith('REACT_NATIVE_') || key.startsWith('EXPO_');\n}\n\nexport async function startExpoServerAsync(projectRoot: string): Promise<void> {\n  _assertValidProjectRoot(projectRoot);\n  await stopExpoServerAsync(projectRoot);\n  let app = express();\n  app.use(\n    express.json({\n      limit: '10mb',\n    })\n  );\n  app.use(\n    express.urlencoded({\n      limit: '10mb',\n      extended: true,\n    })\n  );\n  if (\n    (ConnectionStatus.isOffline()\n      ? await Doctor.validateWithoutNetworkAsync(projectRoot)\n      : await Doctor.validateWithNetworkAsync(projectRoot)) === Doctor.FATAL\n  ) {\n    throw new Error(`Couldn't start project. Please fix the errors and restart the project.`);\n  }\n  // Serve the manifest.\n  const manifestHandler = async (req: express.Request, res: express.Response) => {\n    try {\n      // We intentionally don't `await`. We want to continue trying even\n      // if there is a potential error in the package.json and don't want to slow\n      // down the request\n      Doctor.validateWithNetworkAsync(projectRoot);\n      // Get packager opts and then copy into bundleUrlPackagerOpts\n      let packagerOpts = await ProjectSettings.readAsync(projectRoot);\n      let { exp: manifest } = getConfig(projectRoot);\n      let bundleUrlPackagerOpts = JSON.parse(JSON.stringify(packagerOpts));\n      bundleUrlPackagerOpts.urlType = 'http';\n      if (bundleUrlPackagerOpts.hostType === 'redirect') {\n        bundleUrlPackagerOpts.hostType = 'tunnel';\n      }\n      manifest.xde = true; // deprecated\n      manifest.developer = {\n        tool: Config.developerTool,\n        projectRoot,\n      };\n      manifest.packagerOpts = packagerOpts;\n      manifest.env = {};\n      for (let key of Object.keys(process.env)) {\n        if (shouldExposeEnvironmentVariableInManifest(key)) {\n          manifest.env[key] = process.env[key];\n        }\n      }\n      let platform = (req.headers['exponent-platform'] || 'ios').toString();\n      let entryPoint = Exp.determineEntryPoint(projectRoot, platform);\n      let mainModuleName = UrlUtils.guessMainModulePath(entryPoint);\n      let queryParams = await UrlUtils.constructBundleQueryParamsAsync(projectRoot, packagerOpts);\n      let path = `/${encodeURI(mainModuleName)}.bundle?platform=${encodeURIComponent(\n        platform\n      )}&${queryParams}`;\n      manifest.bundleUrl =\n        (await UrlUtils.constructBundleUrlAsync(projectRoot, bundleUrlPackagerOpts, req.hostname)) +\n        path;\n      manifest.debuggerHost = await UrlUtils.constructDebuggerHostAsync(projectRoot, req.hostname);\n      manifest.mainModuleName = mainModuleName;\n      manifest.logUrl = await UrlUtils.constructLogUrlAsync(projectRoot, req.hostname);\n      manifest.hostUri = await UrlUtils.constructHostUriAsync(projectRoot, req.hostname);\n      await _resolveManifestAssets(\n        projectRoot,\n        manifest as PublicConfig,\n        async path => manifest.bundleUrl.match(/^https?:\\/\\/.*?\\//)[0] + 'assets/' + path\n      ); // the server normally inserts this but if we're offline we'll do it here\n      await _resolveGoogleServicesFile(projectRoot, manifest);\n      const hostUUID = await UserSettings.anonymousIdentifier();\n      let currentSession = await UserManager.getSessionAsync();\n      if (!currentSession || Config.offline) {\n        manifest.id = `@${ANONYMOUS_USERNAME}/${manifest.slug}-${hostUUID}`;\n      }\n      let manifestString = JSON.stringify(manifest);\n      if (req.headers['exponent-accept-signature']) {\n        if (_cachedSignedManifest.manifestString === manifestString) {\n          manifestString = _cachedSignedManifest.signedManifest;\n        } else {\n          if (!currentSession || Config.offline) {\n            const unsignedManifest = {\n              manifestString,\n              signature: 'UNSIGNED',\n            };\n            _cachedSignedManifest.manifestString = manifestString;\n            manifestString = JSON.stringify(unsignedManifest);\n            _cachedSignedManifest.signedManifest = manifestString;\n          } else {\n            let publishInfo = await Exp.getPublishInfoAsync(projectRoot);\n\n            let signedManifest;\n            if (process.env.EXPO_LEGACY_API === 'true') {\n              signedManifest = await Api.callMethodAsync(\n                'signManifest',\n                [publishInfo.args],\n                'post',\n                manifest\n              );\n            } else {\n              const user = await UserManager.ensureLoggedInAsync();\n              const api = ApiV2.clientForUser(user);\n              signedManifest = await api.postAsync('manifest/sign', {\n                args: publishInfo.args,\n                manifest,\n              });\n            }\n            _cachedSignedManifest.manifestString = manifestString;\n            _cachedSignedManifest.signedManifest = signedManifest.response;\n            manifestString = signedManifest.response;\n          }\n        }\n      }\n      const hostInfo = {\n        host: hostUUID,\n        server: 'xdl',\n        serverVersion: require('@expo/xdl/package.json').version,\n        serverDriver: Config.developerTool,\n        serverOS: os.platform(),\n        serverOSVersion: os.release(),\n      };\n      res.append('Exponent-Server', JSON.stringify(hostInfo));\n      res.send(manifestString);\n      Analytics.logEvent('Serve Manifest', {\n        projectRoot,\n        developerTool: Config.developerTool,\n      });\n    } catch (e) {\n      ProjectUtils.logError(projectRoot, 'expo', e.stack);\n      // 5xx = Server Error HTTP code\n      res.status(520).send({\n        error: e.toString(),\n      });\n    }\n  };\n  app.get('/', manifestHandler);\n  app.get('/manifest', manifestHandler);\n  app.get('/index.exp', manifestHandler);\n  app.post('/logs', async (req, res) => {\n    try {\n      let deviceId = req.get('Device-Id');\n      let deviceName = req.get('Device-Name');\n      if (deviceId && deviceName && req.body) {\n        _handleDeviceLogs(projectRoot, deviceId, deviceName, req.body);\n      }\n    } catch (e) {\n      ProjectUtils.logError(projectRoot, 'expo', `Error getting device logs: ${e} ${e.stack}`);\n    }\n    res.send('Success');\n  });\n  app.post('/shutdown', async (req, res) => {\n    server.close();\n    res.send('Success');\n  });\n  let expRc = await readExpRcAsync(projectRoot);\n  let expoServerPort = expRc.manifestPort ? expRc.manifestPort : await _getFreePortAsync(19000);\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    expoServerPort,\n  });\n  let server = app.listen(expoServerPort, () => {\n    const info = server.address() as AddressInfo;\n    const host = info.address;\n    const port = info.port;\n    ProjectUtils.logDebug(projectRoot, 'expo', `Local server listening at http://${host}:${port}`);\n  });\n  await Exp.saveRecentExpRootAsync(projectRoot);\n}\n\nexport async function stopExpoServerAsync(projectRoot: string): Promise<void> {\n  _assertValidProjectRoot(projectRoot);\n  let packagerInfo = await ProjectSettings.readPackagerInfoAsync(projectRoot);\n  if (packagerInfo && packagerInfo.expoServerPort) {\n    try {\n      await axios.post(`http://127.0.0.1:${packagerInfo.expoServerPort}/shutdown`);\n    } catch (e) {}\n  }\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    expoServerPort: null,\n  });\n}\n\nasync function _connectToNgrokAsync(\n  projectRoot: string,\n  args: ngrok.NgrokOptions,\n  hostnameAsync: () => Promise<string>,\n  ngrokPid: number | null | undefined,\n  attempts: number = 0\n): Promise<string> {\n  try {\n    const configPath = path.join(UserSettings.dotExpoHomeDirectory(), 'ngrok.yml');\n    const hostname = await hostnameAsync();\n    const url = await ngrokConnectAsync({\n      hostname,\n      configPath,\n      ...args,\n    });\n    return url;\n  } catch (e) {\n    // Attempt to connect 3 times\n    if (attempts >= 2) {\n      if (e.message) {\n        throw new XDLError('NGROK_ERROR', e.toString());\n      } else {\n        throw new XDLError('NGROK_ERROR', JSON.stringify(e));\n      }\n    }\n    if (!attempts) {\n      attempts = 0;\n    } // Attempt to fix the issue\n    if (e.error_code && e.error_code === 103) {\n      if (attempts === 0) {\n        // Failed to start tunnel. Might be because url already bound to another session.\n        if (ngrokPid) {\n          try {\n            process.kill(ngrokPid, 'SIGKILL');\n          } catch (e) {\n            ProjectUtils.logDebug(projectRoot, 'expo', `Couldn't kill ngrok with PID ${ngrokPid}`);\n          }\n        } else {\n          await ngrokKillAsync();\n        }\n      } else {\n        // Change randomness to avoid conflict if killing ngrok didn't help\n        await Exp.resetProjectRandomnessAsync(projectRoot);\n      }\n    } // Wait 100ms and then try again\n    await delayAsync(100);\n    return _connectToNgrokAsync(projectRoot, args, hostnameAsync, null, attempts + 1);\n  }\n}\n\nexport async function startTunnelsAsync(projectRoot: string): Promise<void> {\n  const username = (await UserManager.getCurrentUsernameAsync()) || ANONYMOUS_USERNAME;\n  _assertValidProjectRoot(projectRoot);\n  const packagerInfo = await ProjectSettings.readPackagerInfoAsync(projectRoot);\n  if (!packagerInfo.packagerPort) {\n    throw new XDLError('NO_PACKAGER_PORT', `No packager found for project at ${projectRoot}.`);\n  }\n  if (!packagerInfo.expoServerPort) {\n    throw new XDLError(\n      'NO_EXPO_SERVER_PORT',\n      `No Expo server found for project at ${projectRoot}.`\n    );\n  }\n  const expoServerPort = packagerInfo.expoServerPort;\n  await stopTunnelsAsync(projectRoot);\n  if (await Android.startAdbReverseAsync(projectRoot)) {\n    ProjectUtils.logInfo(\n      projectRoot,\n      'expo',\n      'Successfully ran `adb reverse`. Localhost URLs should work on the connected Android device.'\n    );\n  }\n  let packageShortName = path.parse(projectRoot).base;\n  let expRc = await readExpRcAsync(projectRoot);\n\n  let startedTunnelsSuccessfully = false;\n\n  // Some issues with ngrok cause it to hang indefinitely. After\n  // TUNNEL_TIMEOUTms we just throw an error.\n  await Promise.race([\n    (async () => {\n      await delayAsync(TUNNEL_TIMEOUT);\n      if (!startedTunnelsSuccessfully) {\n        throw new Error('Starting tunnels timed out');\n      }\n    })(),\n    (async () => {\n      let expoServerNgrokUrl = await _connectToNgrokAsync(\n        projectRoot,\n        {\n          authtoken: Config.ngrok.authToken,\n          port: expoServerPort,\n          proto: 'http',\n        },\n        async () => {\n          let randomness = expRc.manifestTunnelRandomness\n            ? expRc.manifestTunnelRandomness\n            : await Exp.getProjectRandomnessAsync(projectRoot);\n          return [\n            randomness,\n            UrlUtils.domainify(username),\n            UrlUtils.domainify(packageShortName),\n            Config.ngrok.domain,\n          ].join('.');\n        },\n        packagerInfo.ngrokPid\n      );\n      let packagerNgrokUrl = await _connectToNgrokAsync(\n        projectRoot,\n        {\n          authtoken: Config.ngrok.authToken,\n          port: packagerInfo.packagerPort,\n          proto: 'http',\n        },\n        async () => {\n          let randomness = expRc.manifestTunnelRandomness\n            ? expRc.manifestTunnelRandomness\n            : await Exp.getProjectRandomnessAsync(projectRoot);\n          return [\n            'packager',\n            randomness,\n            UrlUtils.domainify(username),\n            UrlUtils.domainify(packageShortName),\n            Config.ngrok.domain,\n          ].join('.');\n        },\n        packagerInfo.ngrokPid\n      );\n      await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n        expoServerNgrokUrl,\n        packagerNgrokUrl,\n        ngrokPid: ngrok.process().pid,\n      });\n\n      startedTunnelsSuccessfully = true;\n\n      ProjectUtils.logWithLevel(\n        projectRoot,\n        'info',\n        {\n          tag: 'expo',\n          _expoEventType: 'TUNNEL_READY',\n        },\n        'Tunnel ready.'\n      );\n\n      ngrok.addListener('statuschange', (status: string) => {\n        if (status === 'reconnecting') {\n          ProjectUtils.logError(\n            projectRoot,\n            'expo',\n            'We noticed your tunnel is having issues. ' +\n              'This may be due to intermittent problems with our tunnel provider. ' +\n              'If you have trouble connecting to your app, try to Restart the project, ' +\n              'or switch Host to LAN.'\n          );\n        } else if (status === 'online') {\n          ProjectUtils.logInfo(projectRoot, 'expo', 'Tunnel connected.');\n        }\n      });\n    })(),\n  ]);\n}\n\nexport async function stopTunnelsAsync(projectRoot: string): Promise<void> {\n  _assertValidProjectRoot(projectRoot);\n  // This will kill all ngrok tunnels in the process.\n  // We'll need to change this if we ever support more than one project\n  // open at a time in XDE.\n  let packagerInfo = await ProjectSettings.readPackagerInfoAsync(projectRoot);\n  let ngrokProcess = ngrok.process();\n  let ngrokProcessPid = ngrokProcess ? ngrokProcess.pid : null;\n  ngrok.removeAllListeners('statuschange');\n  if (packagerInfo.ngrokPid && packagerInfo.ngrokPid !== ngrokProcessPid) {\n    // Ngrok is running in some other process. Kill at the os level.\n    try {\n      process.kill(packagerInfo.ngrokPid);\n    } catch (e) {\n      ProjectUtils.logDebug(\n        projectRoot,\n        'expo',\n        `Couldn't kill ngrok with PID ${packagerInfo.ngrokPid}`\n      );\n    }\n  } else {\n    // Ngrok is running from the current process. Kill using ngrok api.\n    await ngrokKillAsync();\n  }\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    expoServerNgrokUrl: null,\n    packagerNgrokUrl: null,\n    ngrokPid: null,\n  });\n  await Android.stopAdbReverseAsync(projectRoot);\n}\n\nexport async function setOptionsAsync(\n  projectRoot: string,\n  options: {\n    packagerPort?: number;\n  }\n): Promise<void> {\n  _assertValidProjectRoot(projectRoot); // Check to make sure all options are valid\n  let schema = joi.object().keys({\n    packagerPort: joi.number().integer(),\n  });\n  const { error } = joi.validate(options, schema);\n  if (error) {\n    throw new XDLError('INVALID_OPTIONS', error.toString());\n  }\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, options);\n}\n\n// DEPRECATED(2019-08-21): use UrlUtils.constructManifestUrlAsync\nexport async function getUrlAsync(projectRoot: string, options: object = {}): Promise<string> {\n  _assertValidProjectRoot(projectRoot);\n  return await UrlUtils.constructManifestUrlAsync(projectRoot, options);\n}\n\nexport async function startAsync(\n  projectRoot: string,\n  options: StartOptions = {},\n  verbose: boolean = true\n): Promise<ExpoConfig> {\n  _assertValidProjectRoot(projectRoot);\n  Analytics.logEvent('Start Project', {\n    projectRoot,\n    developerTool: Config.developerTool,\n  });\n\n  let { exp } = getConfig(projectRoot);\n  if (options.webOnly) {\n    await Webpack.restartAsync(projectRoot, options);\n    DevSession.startSession(projectRoot, exp, 'web');\n    return exp;\n  } else {\n    await startExpoServerAsync(projectRoot);\n    await startReactNativeServerAsync(projectRoot, options, verbose);\n    DevSession.startSession(projectRoot, exp, 'native');\n  }\n\n  if (!Config.offline) {\n    try {\n      await startTunnelsAsync(projectRoot);\n    } catch (e) {\n      ProjectUtils.logDebug(projectRoot, 'expo', `Error starting tunnel ${e.message}`);\n    }\n  }\n  return exp;\n}\n\nasync function _stopInternalAsync(projectRoot: string): Promise<void> {\n  DevSession.stopSession();\n  await Webpack.stopAsync(projectRoot);\n  ProjectUtils.logInfo(projectRoot, 'expo', '\\u203A Closing Expo server');\n  await stopExpoServerAsync(projectRoot);\n  ProjectUtils.logInfo(projectRoot, 'expo', '\\u203A Stopping Metro bundler');\n  await stopReactNativeServerAsync(projectRoot);\n  if (!Config.offline) {\n    try {\n      await stopTunnelsAsync(projectRoot);\n    } catch (e) {\n      ProjectUtils.logDebug(projectRoot, 'expo', `Error stopping ngrok ${e.message}`);\n    }\n  }\n}\n\nexport async function stopWebOnlyAsync(projectDir: string): Promise<void> {\n  await Webpack.stopAsync(projectDir);\n  await DevSession.stopSession();\n}\n\nexport async function stopAsync(projectDir: string): Promise<void> {\n  const result = await Promise.race([\n    _stopInternalAsync(projectDir),\n    new Promise(resolve => setTimeout(resolve, 2000, 'stopFailed')),\n  ]);\n  if (result === 'stopFailed') {\n    // find RN packager and ngrok pids, attempt to kill them manually\n    const { packagerPid, ngrokPid } = await ProjectSettings.readPackagerInfoAsync(projectDir);\n    if (packagerPid) {\n      try {\n        process.kill(packagerPid);\n      } catch (e) {}\n    }\n    if (ngrokPid) {\n      try {\n        process.kill(ngrokPid);\n      } catch (e) {}\n    }\n    await ProjectSettings.setPackagerInfoAsync(projectDir, {\n      expoServerPort: null,\n      packagerPort: null,\n      packagerPid: null,\n      expoServerNgrokUrl: null,\n      packagerNgrokUrl: null,\n      ngrokPid: null,\n      webpackServerPort: null,\n    });\n  }\n}\n"],"file":"../Project.js","sourceRoot":"/@expo/xdl@57.7.1/src"}