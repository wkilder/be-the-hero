{"version":3,"file":"PackageManager.js","sourceRoot":"","sources":["../src/PackageManager.ts"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA,4DAAmC;AACnC,wFAAyD;AACzD,oEAA6D;AAC7D,kDAA0B;AAC1B,mCAAmC;AACnC,sEAA4C;AAC5C,wDAA0B;AAC1B,gDAAwB;AACxB,kEAAyC;AACzC,oEAA2C;AAE3C,MAAM,IAAI,GAAG,MAAM,oBAAS,EAAE,CAAC,MAAM,IAAI,CAAC;AAC1C,MAAM,+BAA+B,GAAG,IAAI,MAAM,CAChD,GAAG,IAAI,MAAM,IAAI,IAAI,IAAI,OAAO,IAAI,oDAAoD,EACxF,GAAG,CACJ,CAAC;AACF,MAAM,gCAAgC,GAAG,IAAI,MAAM,CACjD,GAAG,IAAI,UAAU,IAAI,+DAA+D,EACpF,GAAG,CACJ,CAAC;AAEF;;;;GAIG;AACH,SAAgB,WAAW,CAAC,WAAmB;IAC7C,MAAM,aAAa,GAAG,kCAAiB,CAAC,WAAW,CAAC,CAAC;IACrD,IAAI,aAAa,EAAE;QACjB,OAAO,kBAAE,CAAC,UAAU,CAAC,cAAI,CAAC,IAAI,CAAC,aAAa,EAAE,WAAW,CAAC,CAAC,CAAC;KAC7D;IACD,OAAO,kBAAE,CAAC,UAAU,CAAC,cAAI,CAAC,IAAI,CAAC,WAAW,EAAE,WAAW,CAAC,CAAC,CAAC;AAC5D,CAAC;AAND,kCAMC;AAED,MAAM,kBAAmB,SAAQ,kBAAS;IACxC,UAAU,CACR,KAAa,EACb,QAAgB,EAChB,QAAoD;QAEpD,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,QAAQ,EAAE,CAAC,OAAO,CAAC,+BAA+B,EAAE,EAAE,CAAC,CAAC,CAAC;QACzE,QAAQ,EAAE,CAAC;IACb,CAAC;CACF;AAED,MAAM,mBAAoB,SAAQ,kBAAS;IACzC,UAAU,CACR,KAAa,EACb,QAAgB,EAChB,QAAoD;QAEpD,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,QAAQ,EAAE,CAAC,OAAO,CAAC,gCAAgC,EAAE,EAAE,CAAC,CAAC,CAAC;QAC1E,QAAQ,EAAE,CAAC;IACb,CAAC;CACF;AAYD,MAAa,iBAAiB;IAI5B,YAAY,EAAE,GAAG,EAAE,GAAG,EAAiC;QACrD,IAAI,CAAC,GAAG,GAAG,GAAG,IAAI,OAAO,CAAC,GAAG,CAAC;QAC9B,IAAI,CAAC,OAAO,GAAG,EAAE,GAAG,EAAE,KAAK,EAAE,CAAC,SAAS,EAAE,SAAS,EAAE,MAAM,CAAC,EAAE,CAAC;IAChE,CAAC;IACD,IAAI,IAAI;QACN,OAAO,KAAK,CAAC;IACf,CAAC;IACK,YAAY;;YAChB,MAAM,IAAI,CAAC,SAAS,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC;QACpC,CAAC;KAAA;IACK,QAAQ,CAAC,GAAG,KAAe;;YAC/B,MAAM,EAAE,SAAS,EAAE,WAAW,EAAE,GAAG,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;YAC3D,IAAI,SAAS,CAAC,MAAM,EAAE;gBACpB,MAAM,IAAI,CAAC,WAAW,CAAC,SAAS,EAAE,cAAc,CAAC,CAAC;gBAClD,MAAM,IAAI,CAAC,SAAS,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC;aACnC;YACD,IAAI,WAAW,CAAC,MAAM,EAAE;gBACtB,MAAM,IAAI,CAAC,SAAS,CAAC,CAAC,SAAS,EAAE,QAAQ,EAAE,GAAG,WAAW,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;aACnF;QACH,CAAC;KAAA;IACK,WAAW,CAAC,GAAG,KAAe;;YAClC,MAAM,EAAE,SAAS,EAAE,WAAW,EAAE,GAAG,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;YAC3D,IAAI,SAAS,CAAC,MAAM,EAAE;gBACpB,MAAM,IAAI,CAAC,WAAW,CAAC,SAAS,EAAE,iBAAiB,CAAC,CAAC;gBACrD,MAAM,IAAI,CAAC,SAAS,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC;aACnC;YACD,IAAI,WAAW,CAAC,MAAM,EAAE;gBACtB,MAAM,IAAI,CAAC,SAAS,CAAC,CAAC,SAAS,EAAE,YAAY,EAAE,GAAG,WAAW,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;aACvF;QACH,CAAC;KAAA;IACK,YAAY;;YAChB,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,qBAAU,CAAC,KAAK,EAAE,CAAC,WAAW,CAAC,EAAE,EAAE,KAAK,EAAE,MAAM,EAAE,CAAC,CAAC;YAC7E,OAAO,MAAM,CAAC,IAAI,EAAE,CAAC;QACvB,CAAC;KAAA;IACK,cAAc,CAAC,GAAW;;YAC9B,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,qBAAU,CAAC,KAAK,EAAE,CAAC,QAAQ,EAAE,KAAK,EAAE,GAAG,CAAC,EAAE,EAAE,KAAK,EAAE,MAAM,EAAE,CAAC,CAAC;YACtF,OAAO,MAAM,CAAC,IAAI,EAAE,CAAC;QACvB,CAAC;KAAA;IAED,UAAU;IACI,SAAS,CAAC,IAAc;;YACpC,IAAI,CAAC,GAAG,CAAC,SAAS,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;YACpC,MAAM,OAAO,GAAG,qBAAU,CAAC,KAAK,EAAE,CAAC,GAAG,IAAI,CAAC,EAAE,IAAI,CAAC,OAAO,CAAC,CAAC;YAC3D,IAAI,OAAO,CAAC,KAAK,CAAC,MAAM,EAAE;gBACxB,OAAO,CAAC,KAAK,CAAC,MAAM;qBACjB,IAAI,CAAC,eAAK,CAAC,OAAO,EAAE,CAAC,IAAY,EAAE,EAAE,CAAC,IAAI,GAAG,IAAI,CAAC,CAAC;qBACnD,IAAI,CAAC,IAAI,kBAAkB,EAAE,CAAC;qBAC9B,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;aACzB;YACD,OAAO,OAAO,CAAC;QACjB,CAAC;KAAA;IAEO,WAAW,CAAC,KAAe;QACjC,MAAM,MAAM,GAGR,EAAE,SAAS,EAAE,EAAE,EAAE,WAAW,EAAE,EAAE,EAAE,CAAC;QACvC,KAAK;aACF,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,yBAAa,CAAC,IAAI,CAAC,CAAC;aAChC,OAAO,CAAC,IAAI,CAAC,EAAE;YACd,IAAI,IAAI,CAAC,OAAO,EAAE;gBAChB,MAAM,CAAC,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;aAC7B;iBAAM;gBACL,MAAM,CAAC,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;aAC/B;QACH,CAAC,CAAC,CAAC;QACL,OAAO,MAAM,CAAC;IAChB,CAAC;IAEa,WAAW,CACvB,KAA6B,EAC7B,WAA+C;;YAE/C,MAAM,OAAO,GAAG,cAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,IAAI,GAAG,EAAE,cAAc,CAAC,CAAC;YACnE,MAAM,MAAM,GAAG,MAAM,kBAAE,CAAC,QAAQ,CAAC,OAAO,EAAE,EAAE,QAAQ,EAAE,MAAM,EAAE,IAAI,EAAE,GAAG,EAAE,CAAC,CAAC;YAC3E,MAAM,GAAG,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;YAC/B,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE;gBACnB,GAAG,CAAC,WAAW,CAAC,GAAG,GAAG,CAAC,WAAW,CAAC,IAAI,EAAE,CAAC;gBAC1C,GAAG,CAAC,WAAW,CAAC,CAAC,IAAI,CAAC,IAAK,CAAC,GAAG,IAAI,CAAC,OAAO,CAAC;YAC9C,CAAC,CAAC,CAAC;YACH,MAAM,kBAAE,CAAC,SAAS,CAAC,OAAO,EAAE,GAAG,EAAE;gBAC/B,MAAM,EAAE,uBAAY,CAAC,MAAM,CAAC,CAAC,MAAM;gBACnC,GAAG,EAAE,wBAAa,CAAC,MAAM,CAAC;aAC3B,CAAC,CAAC;QACL,CAAC;KAAA;CACF;AAzFD,8CAyFC;AAED,MAAa,kBAAkB;IAI7B,YAAY,EAAE,GAAG,EAAE,GAAG,EAAiC;QACrD,IAAI,CAAC,GAAG,GAAG,GAAG,IAAI,OAAO,CAAC,GAAG,CAAC;QAC9B,IAAI,CAAC,OAAO,GAAG;YACb,GAAG;YACH,KAAK,EAAE,CAAC,SAAS,EAAE,SAAS,EAAE,MAAM,CAAC;SACtC,CAAC;IACJ,CAAC;IACD,IAAI,IAAI;QACN,OAAO,MAAM,CAAC;IAChB,CAAC;IACK,YAAY;;YAChB,MAAM,IAAI,CAAC,SAAS,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC;QACpC,CAAC;KAAA;IACK,QAAQ,CAAC,GAAG,KAAe;;YAC/B,MAAM,IAAI,CAAC,SAAS,CAAC,CAAC,KAAK,EAAE,GAAG,KAAK,CAAC,CAAC,CAAC;QAC1C,CAAC;KAAA;IACK,WAAW,CAAC,GAAG,KAAe;;YAClC,MAAM,IAAI,CAAC,SAAS,CAAC,CAAC,KAAK,EAAE,OAAO,EAAE,GAAG,KAAK,CAAC,CAAC,CAAC;QACnD,CAAC;KAAA;IACK,YAAY;;YAChB,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,qBAAU,CAAC,SAAS,EAAE,CAAC,WAAW,CAAC,EAAE,EAAE,KAAK,EAAE,MAAM,EAAE,CAAC,CAAC;YACjF,OAAO,MAAM,CAAC,IAAI,EAAE,CAAC;QACvB,CAAC;KAAA;IACK,cAAc,CAAC,GAAW;;YAC9B,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,qBAAU,CAAC,SAAS,EAAE,CAAC,QAAQ,EAAE,KAAK,EAAE,GAAG,CAAC,EAAE,EAAE,KAAK,EAAE,MAAM,EAAE,CAAC,CAAC;YAC1F,OAAO,MAAM,CAAC,IAAI,EAAE,CAAC;QACvB,CAAC;KAAA;IAED,UAAU;IACI,SAAS,CAAC,IAAc;;YACpC,IAAI,CAAC,GAAG,CAAC,UAAU,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;YACrC,MAAM,OAAO,GAAG,qBAAU,CAAC,SAAS,EAAE,IAAI,EAAE,IAAI,CAAC,OAAO,CAAC,CAAC;YAC1D,IAAI,OAAO,CAAC,KAAK,CAAC,MAAM,EAAE;gBACxB,OAAO,CAAC,KAAK,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,mBAAmB,EAAE,CAAC,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;aAC3E;YACD,OAAO,OAAO,CAAC;QACjB,CAAC;KAAA;CACF;AAzCD,gDAyCC;AAID,SAAgB,gBAAgB,CAC9B,WAAmB,EACnB,UAAmC,EAAE;IAErC,IAAI,cAAc,CAAC;IACnB,IAAI,OAAO,CAAC,GAAG,EAAE;QACf,cAAc,GAAG,iBAAiB,CAAC;KACpC;SAAM,IAAI,OAAO,CAAC,IAAI,EAAE;QACvB,cAAc,GAAG,kBAAkB,CAAC;KACrC;SAAM,IAAI,WAAW,CAAC,WAAW,CAAC,EAAE;QACnC,cAAc,GAAG,kBAAkB,CAAC;KACrC;SAAM;QACL,cAAc,GAAG,iBAAiB,CAAC;KACpC;IACD,OAAO,IAAI,cAAc,CAAC,EAAE,GAAG,EAAE,WAAW,EAAE,GAAG,EAAE,OAAO,CAAC,GAAG,EAAE,CAAC,CAAC;AACpE,CAAC;AAfD,4CAeC;AAED,SAAgB,cAAc,CAAC,WAAmB;IAChD,MAAM,aAAa,GAAG,kCAAiB,CAAC,cAAI,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC,wBAAwB;IAC5F,IAAI,aAAa,EAAE;QACjB,OAAO,cAAI,CAAC,OAAO,CAAC,aAAa,EAAE,cAAc,CAAC,CAAC;KACpD;IAED,OAAO,cAAI,CAAC,OAAO,CAAC,WAAW,EAAE,cAAc,CAAC,CAAC;AACnD,CAAC;AAPD,wCAOC;AAED,SAAgB,sBAAsB;IACpC,OAAO,kBAAE,CAAC,YAAY,CAAC,OAAO,CAAC,GAAG,EAAE,CAAC,CAAC;AACxC,CAAC;AAFD,wDAEC","sourcesContent":["import ansiRegex from 'ansi-regex';\nimport findWorkspaceRoot from 'find-yarn-workspace-root';\nimport spawnAsync, { SpawnOptions } from '@expo/spawn-async';\nimport split from 'split';\nimport { Transform } from 'stream';\nimport npmPackageArg from 'npm-package-arg';\nimport fs from 'fs-extra';\nimport path from 'path';\nimport detectIndent from 'detect-indent';\nimport detectNewline from 'detect-newline';\n\nconst ansi = `(?:${ansiRegex().source})*`;\nconst npmPeerDependencyWarningPattern = new RegExp(\n  `${ansi}npm${ansi} ${ansi}WARN${ansi}.+You must install peer dependencies yourself\\\\.\\n`,\n  'g'\n);\nconst yarnPeerDependencyWarningPattern = new RegExp(\n  `${ansi}warning${ansi} \"[^\"]+\" has (?:unmet|incorrect) peer dependency \"[^\"]+\"\\\\.\\n`,\n  'g'\n);\n\n/**\n * Returns true if the project is using yarn, false if the project is using npm.\n *\n * @param projectRoot\n */\nexport function isUsingYarn(projectRoot: string): boolean {\n  const workspaceRoot = findWorkspaceRoot(projectRoot);\n  if (workspaceRoot) {\n    return fs.existsSync(path.join(workspaceRoot, 'yarn.lock'));\n  }\n  return fs.existsSync(path.join(projectRoot, 'yarn.lock'));\n}\n\nclass NpmStderrTransform extends Transform {\n  _transform(\n    chunk: Buffer,\n    encoding: string,\n    callback: (error?: Error | null, data?: any) => void\n  ) {\n    this.push(chunk.toString().replace(npmPeerDependencyWarningPattern, ''));\n    callback();\n  }\n}\n\nclass YarnStderrTransform extends Transform {\n  _transform(\n    chunk: Buffer,\n    encoding: string,\n    callback: (error?: Error | null, data?: any) => void\n  ) {\n    this.push(chunk.toString().replace(yarnPeerDependencyWarningPattern, ''));\n    callback();\n  }\n}\n\ntype Logger = (...args: any[]) => void;\n\nexport interface PackageManager {\n  installAsync(): Promise<void>;\n  addAsync(...names: string[]): Promise<void>;\n  addDevAsync(...names: string[]): Promise<void>;\n  versionAsync(): Promise<string>;\n  getConfigAsync(key: string): Promise<string>;\n}\n\nexport class NpmPackageManager implements PackageManager {\n  options: SpawnOptions;\n  private log: Logger;\n\n  constructor({ cwd, log }: { cwd: string; log?: Logger }) {\n    this.log = log || console.log;\n    this.options = { cwd, stdio: ['inherit', 'inherit', 'pipe'] };\n  }\n  get name() {\n    return 'npm';\n  }\n  async installAsync() {\n    await this._runAsync(['install']);\n  }\n  async addAsync(...names: string[]) {\n    const { versioned, unversioned } = this._parseSpecs(names);\n    if (versioned.length) {\n      await this._patchAsync(versioned, 'dependencies');\n      await this._runAsync(['install']);\n    }\n    if (unversioned.length) {\n      await this._runAsync(['install', '--save', ...unversioned.map(spec => spec.raw)]);\n    }\n  }\n  async addDevAsync(...names: string[]) {\n    const { versioned, unversioned } = this._parseSpecs(names);\n    if (versioned.length) {\n      await this._patchAsync(versioned, 'devDependencies');\n      await this._runAsync(['install']);\n    }\n    if (unversioned.length) {\n      await this._runAsync(['install', '--save-dev', ...unversioned.map(spec => spec.raw)]);\n    }\n  }\n  async versionAsync() {\n    const { stdout } = await spawnAsync('npm', ['--version'], { stdio: 'pipe' });\n    return stdout.trim();\n  }\n  async getConfigAsync(key: string) {\n    const { stdout } = await spawnAsync('npm', ['config', 'get', key], { stdio: 'pipe' });\n    return stdout.trim();\n  }\n\n  // Private\n  private async _runAsync(args: string[]) {\n    this.log(`> npm ${args.join(' ')}`);\n    const promise = spawnAsync('npm', [...args], this.options);\n    if (promise.child.stderr) {\n      promise.child.stderr\n        .pipe(split(/\\r?\\n/, (line: string) => line + '\\n'))\n        .pipe(new NpmStderrTransform())\n        .pipe(process.stderr);\n    }\n    return promise;\n  }\n\n  private _parseSpecs(names: string[]) {\n    const result: {\n      versioned: npmPackageArg.Result[];\n      unversioned: npmPackageArg.Result[];\n    } = { versioned: [], unversioned: [] };\n    names\n      .map(name => npmPackageArg(name))\n      .forEach(spec => {\n        if (spec.rawSpec) {\n          result.versioned.push(spec);\n        } else {\n          result.unversioned.push(spec);\n        }\n      });\n    return result;\n  }\n\n  private async _patchAsync(\n    specs: npmPackageArg.Result[],\n    packageType: 'dependencies' | 'devDependencies'\n  ) {\n    const pkgPath = path.join(this.options.cwd || '.', 'package.json');\n    const pkgRaw = await fs.readFile(pkgPath, { encoding: 'utf8', flag: 'r' });\n    const pkg = JSON.parse(pkgRaw);\n    specs.forEach(spec => {\n      pkg[packageType] = pkg[packageType] || {};\n      pkg[packageType][spec.name!] = spec.rawSpec;\n    });\n    await fs.writeJson(pkgPath, pkg, {\n      spaces: detectIndent(pkgRaw).indent,\n      EOL: detectNewline(pkgRaw),\n    });\n  }\n}\n\nexport class YarnPackageManager implements PackageManager {\n  options: SpawnOptions;\n  private log: Logger;\n\n  constructor({ cwd, log }: { cwd: string; log?: Logger }) {\n    this.log = log || console.log;\n    this.options = {\n      cwd,\n      stdio: ['inherit', 'inherit', 'pipe'],\n    };\n  }\n  get name() {\n    return 'Yarn';\n  }\n  async installAsync() {\n    await this._runAsync(['install']);\n  }\n  async addAsync(...names: string[]) {\n    await this._runAsync(['add', ...names]);\n  }\n  async addDevAsync(...names: string[]) {\n    await this._runAsync(['add', '--dev', ...names]);\n  }\n  async versionAsync() {\n    const { stdout } = await spawnAsync('yarnpkg', ['--version'], { stdio: 'pipe' });\n    return stdout.trim();\n  }\n  async getConfigAsync(key: string) {\n    const { stdout } = await spawnAsync('yarnpkg', ['config', 'get', key], { stdio: 'pipe' });\n    return stdout.trim();\n  }\n\n  // Private\n  private async _runAsync(args: string[]) {\n    this.log(`> yarn ${args.join(' ')}`);\n    const promise = spawnAsync('yarnpkg', args, this.options);\n    if (promise.child.stderr) {\n      promise.child.stderr.pipe(new YarnStderrTransform()).pipe(process.stderr);\n    }\n    return promise;\n  }\n}\n\nexport type CreateForProjectOptions = { npm?: boolean; yarn?: boolean; log?: Logger };\n\nexport function createForProject(\n  projectRoot: string,\n  options: CreateForProjectOptions = {}\n): NpmPackageManager | YarnPackageManager {\n  let PackageManager;\n  if (options.npm) {\n    PackageManager = NpmPackageManager;\n  } else if (options.yarn) {\n    PackageManager = YarnPackageManager;\n  } else if (isUsingYarn(projectRoot)) {\n    PackageManager = YarnPackageManager;\n  } else {\n    PackageManager = NpmPackageManager;\n  }\n  return new PackageManager({ cwd: projectRoot, log: options.log });\n}\n\nexport function getModulesPath(projectRoot: string): string {\n  const workspaceRoot = findWorkspaceRoot(path.resolve(projectRoot)); // Absolute path or null\n  if (workspaceRoot) {\n    return path.resolve(workspaceRoot, 'node_modules');\n  }\n\n  return path.resolve(projectRoot, 'node_modules');\n}\n\nexport function getPossibleProjectRoot(): string {\n  return fs.realpathSync(process.cwd());\n}\n"]}