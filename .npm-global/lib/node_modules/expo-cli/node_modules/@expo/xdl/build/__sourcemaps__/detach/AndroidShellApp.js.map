{"version":3,"sources":["detach/AndroidShellApp.js"],"names":["getManifestAsync","saveUrlToPathAsync","spawnAsyncThrowError","spawnAsync","regexFileAsync","deleteLinesInFileAsync","parseSdkMajorVersion","ExponentTools","imageKeys","exponentDirectory","workingDir","process","env","EXPO_UNIVERSE_DIR","path","join","xmlWeirdAndroidEscape","original","let","noAmps","replaceString","noLt","noGt","noApos","exports","updateAndroidShellAppAsync","async","args","url","sdkVersion","releaseChannel","manifest","await","Accept","fullManifestUrl","replace","bundleUrl","shellPath","fs","remove","writeFileSync","JSON","stringify","getRemoteOrLocalUrl","key","isDetached","_","get","backgroundImagesForApp","basePath","splash","results","reduce","acc","imageKey","push","length","getSplashScreenBackgroundColor","backgroundColor","android","shouldShowLoadingView","resizeMode","copyInitialShellAppFilesAsync","androidSrcPath","pipeToLogger","loggerFields","buildPhase","cwd","copyToShellApp","fileName","copy","e","code","Error","message","createAndroidShellAppAsync","privateConfigFile","configuration","keystore","alias","keystorePassword","keyPassword","outputFile","modules","buildType","buildMode","exponentDir","ensureDir","logger","withFields","info","privateConfig","privateConfigContents","readFile","parse","config","androidBuildConfiguration","keyAlias","buildFlags","StandaloneBuildFlags","createAndroid","context","StandaloneContext","createServiceContext","removeObsoleteSdks","runShellAppModificationsAsync","prepareEnabledModules","skipBuild","buildShellAppAsync","shellPathForContext","type","data","projectPath","expoSourcePath","getPrivateConfig","exp","fnLogger","published","isRunningInUserContext","versionCode","javaPackage","package","name","scheme","detach","isFullManifest","version","backgroundImages","splashBackgroundColor","updatesDisabled","updates","enabled","appBuildGradle","settingsGradle","writeFile","runShPath","pathExists","randomID","uuid","v4","newScheme","newSchemeSuffix","intentFilters","renderIntentFilters","schemes","filter","searchLine","schemesTags","map","facebookScheme","permissions","whitelist","forEach","s","includes","blacklist","p","createAndWriteIconsToPathAsync","globby","absolute","filePath","removeSync","Promise","all","image","resolve","AssetBundle","bundleAsync","bundledAssets","certificateHash","googleAndroidApiKey","branch","fabric","googleMaps","googleSignIn","googleMobileAdsAppId","googleMobileAdsAutoInit","apiKey","buildSecret","googleServicesFile","googleServicesFileContents","facebookAppId","facebookDisplayName","facebookAutoInitEnabled","facebookAutoLogAppEventsEnabled","facebookAdvertiserIDCollectionEnabled","ext","isRelease","build","debugOrRelease","devOrProd","debugOrReleaseL","devOrProdL","shellFile","shellUnalignedFile","outputDirPath","gradleBuildCommand","outputPath","removeIfExists","gradleArgs","GRADLE_DAEMON_DISABLED","unshift","ANDROID_KEY_ALIAS","ANDROID_KEY_PASSWORD","ANDROID_KEYSTORE_PATH","ANDROID_KEYSTORE_PASSWORD","addDetachedConfigToExp","console","warn","assetsDirectory","publishBundlePath","relative","publishManifestPath","removeInvalidSdkLinesWhenPreparingShell","majorSdkVersion","RegExp","requiredSdkVersion","filePathsToTransform","expoviewBuildGradle","settingsBuildGradle","multipleVersionReactNativeActivity","constants","appAndroidManifest","effectiveSdkVersion","Object","values","enabledModulesDir","packagesDir","ensureSymlink","mkdirp","mod","dirname"],"mappings":"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","file":"../../detach/AndroidShellApp.js","sourcesContent":["import fs from 'fs-extra';\nimport path from 'path';\nimport replaceString from 'replace-string';\nimport _ from 'lodash';\nimport globby from 'globby';\nimport uuid from 'uuid';\n\nimport { createAndWriteIconsToPathAsync } from './AndroidIcons';\nimport * as AssetBundle from './AssetBundle';\nimport * as ExponentTools from './ExponentTools';\nimport StandaloneBuildFlags from './StandaloneBuildFlags';\nimport StandaloneContext from './StandaloneContext';\nimport renderIntentFilters from './AndroidIntentFilters';\nimport logger from './Logger';\n\nconst {\n  getManifestAsync,\n  saveUrlToPathAsync,\n  spawnAsyncThrowError,\n  spawnAsync,\n  regexFileAsync,\n  deleteLinesInFileAsync,\n  parseSdkMajorVersion,\n} = ExponentTools;\n\nconst imageKeys = ['mdpi', 'hdpi', 'xhdpi', 'xxhdpi', 'xxxhdpi'];\n\n// Do not call this from anything used by detach\nfunction exponentDirectory(workingDir) {\n  if (workingDir) {\n    return workingDir;\n  } else if (process.env.EXPO_UNIVERSE_DIR) {\n    return path.join(process.env.EXPO_UNIVERSE_DIR, 'exponent');\n  } else {\n    return null;\n  }\n}\n\nfunction xmlWeirdAndroidEscape(original) {\n  let noAmps = replaceString(original, '&', '&amp;');\n  let noLt = replaceString(noAmps, '<', '&lt;');\n  let noGt = replaceString(noLt, '>', '&gt;');\n  let noApos = replaceString(noGt, '\"', '\\\\\"');\n  return replaceString(noApos, \"'\", \"\\\\'\");\n}\n\nexports.updateAndroidShellAppAsync = async function updateAndroidShellAppAsync(args) {\n  let { url, sdkVersion, releaseChannel, workingDir } = args;\n\n  releaseChannel = releaseChannel ? releaseChannel : 'default';\n  let manifest = await getManifestAsync(url, {\n    'Exponent-SDK-Version': sdkVersion,\n    'Exponent-Platform': 'android',\n    'Expo-Release-Channel': releaseChannel,\n    Accept: 'application/expo+json,application/json',\n  });\n\n  let fullManifestUrl = url.replace('exp://', 'https://');\n  let bundleUrl = manifest.bundleUrl;\n\n  let shellPath = path.join(exponentDirectory(workingDir), 'android-shell-app');\n\n  await fs.remove(path.join(shellPath, 'app', 'src', 'main', 'assets', 'shell-app-manifest.json'));\n  await fs.writeFileSync(\n    path.join(shellPath, 'app', 'src', 'main', 'assets', 'shell-app-manifest.json'),\n    JSON.stringify(manifest)\n  );\n  await fs.remove(path.join(shellPath, 'app', 'src', 'main', 'assets', 'shell-app.bundle'));\n  await saveUrlToPathAsync(\n    bundleUrl,\n    path.join(shellPath, 'app', 'src', 'main', 'assets', 'shell-app.bundle')\n  );\n\n  await deleteLinesInFileAsync(\n    `START EMBEDDED RESPONSES`,\n    `END EMBEDDED RESPONSES`,\n    path.join(\n      shellPath,\n      'app',\n      'src',\n      'main',\n      'java',\n      'host',\n      'exp',\n      'exponent',\n      'generated',\n      'AppConstants.java'\n    )\n  );\n\n  await regexFileAsync(\n    '// ADD EMBEDDED RESPONSES HERE',\n    `\n    // ADD EMBEDDED RESPONSES HERE\n    // START EMBEDDED RESPONSES\n    embeddedResponses.add(new Constants.EmbeddedResponse(\"${fullManifestUrl}\", \"assets://shell-app-manifest.json\", \"application/json\"));\n    embeddedResponses.add(new Constants.EmbeddedResponse(\"${bundleUrl}\", \"assets://shell-app.bundle\", \"application/javascript\"));\n    // END EMBEDDED RESPONSES`,\n    path.join(\n      shellPath,\n      'app',\n      'src',\n      'main',\n      'java',\n      'host',\n      'exp',\n      'exponent',\n      'generated',\n      'AppConstants.java'\n    )\n  );\n\n  await regexFileAsync(\n    'RELEASE_CHANNEL = \"default\"',\n    `RELEASE_CHANNEL = \"${releaseChannel}\"`,\n    path.join(\n      shellPath,\n      'app',\n      'src',\n      'main',\n      'java',\n      'host',\n      'exp',\n      'exponent',\n      'generated',\n      'AppConstants.java'\n    )\n  );\n};\n\nfunction getRemoteOrLocalUrl(manifest, key, isDetached) {\n  // in detached apps, `manifest` is actually just app.json, so there are no remote url fields\n  // we should return a local url starting with file:// instead\n  if (isDetached) {\n    return _.get(manifest, key);\n  }\n  return _.get(manifest, `${key}Url`);\n}\n\nfunction backgroundImagesForApp(shellPath, manifest, isDetached) {\n  // returns an array like:\n  // [\n  //   {url: 'urlToDownload', path: 'pathToSaveTo'},\n  //   {url: 'anotherURlToDownload', path: 'anotherPathToSaveTo'},\n  // ]\n  let basePath = path.join(shellPath, 'app', 'src', 'main', 'res');\n  if (_.get(manifest, 'android.splash')) {\n    const splash = _.get(manifest, 'android.splash');\n    const results = _.reduce(\n      imageKeys,\n      function(acc, imageKey) {\n        let url = getRemoteOrLocalUrl(splash, imageKey, isDetached);\n        if (url) {\n          acc.push({\n            url,\n            path: path.join(basePath, `drawable-${imageKey}`, 'shell_launch_background_image.png'),\n          });\n        }\n\n        return acc;\n      },\n      []\n    );\n\n    // No splash screen images declared in 'android.splash' configuration, proceed to general one\n    if (results.length !== 0) {\n      return results;\n    }\n  }\n\n  let url = getRemoteOrLocalUrl(manifest, 'splash.image', isDetached);\n  if (url) {\n    return [\n      {\n        url,\n        path: path.join(basePath, 'drawable-xxxhdpi', 'shell_launch_background_image.png'),\n      },\n    ];\n  }\n\n  return [];\n}\n\nfunction getSplashScreenBackgroundColor(manifest) {\n  let backgroundColor;\n  if (manifest.android && manifest.android.splash && manifest.android.splash.backgroundColor) {\n    backgroundColor = manifest.android.splash.backgroundColor;\n  } else if (manifest.splash && manifest.splash.backgroundColor) {\n    backgroundColor = manifest.splash.backgroundColor;\n  }\n\n  // Default to white\n  if (!backgroundColor) {\n    backgroundColor = '#FFFFFF';\n  }\n  return backgroundColor;\n}\n\n/*\n  if resizeMode is 'contain' or 'cover' (since SDK33) or 'cover' (prior to SDK33) we should show LoadingView\n  that is presenting splash image in ImageView what allows full control over image sizing unlike\n  ImageDrawable that is provided by Android native splash screen API\n*/\nfunction shouldShowLoadingView(manifest, sdkVersion) {\n  const resizeMode =\n    (manifest.android && manifest.android.splash && manifest.android.splash.resizeMode) ||\n    (manifest.splash && manifest.splash.resizeMode);\n\n  return (\n    resizeMode &&\n    (parseSdkMajorVersion(sdkVersion) >= 33\n      ? resizeMode === 'contain' || resizeMode === 'cover'\n      : resizeMode === 'cover')\n  );\n}\n\nexport async function copyInitialShellAppFilesAsync(\n  androidSrcPath,\n  shellPath,\n  isDetached,\n  sdkVersion\n) {\n  if (androidSrcPath && !isDetached) {\n    // check if Android template files exist\n    // since we take out the prebuild step later on\n    // and we should have generated those files earlier\n    await spawnAsyncThrowError('../../tools-public/check-dynamic-macros-android.sh', [], {\n      pipeToLogger: true,\n      loggerFields: { buildPhase: 'confirming that dynamic macros exist' },\n      cwd: path.join(androidSrcPath, 'app'),\n      env: process.env,\n    });\n  }\n\n  const copyToShellApp = async fileName => {\n    try {\n      await fs.copy(path.join(androidSrcPath, fileName), path.join(shellPath, fileName));\n    } catch (e) {\n      // android.iml is only available locally, not on the builders, so don't crash when this happens\n      if (e.code === 'ENOENT') {\n        // Some files are not included in all ExpoKit versions, so this error can be ignored.\n      } else {\n        throw new Error(`Could not copy ${fileName} to shell app directory: ${e.message}`);\n      }\n    }\n  };\n\n  if (!isDetached) {\n    await copyToShellApp('expoview');\n    await copyToShellApp('versioned-abis');\n    await copyToShellApp('ReactCommon');\n    await copyToShellApp('ReactAndroid');\n  }\n\n  await copyToShellApp('android.iml');\n  await copyToShellApp('app');\n  await copyToShellApp('build.gradle');\n  await copyToShellApp('gradle');\n  await copyToShellApp('gradle.properties');\n  await copyToShellApp('gradlew');\n  await copyToShellApp('settings.gradle');\n  await copyToShellApp('debug.keystore');\n  await copyToShellApp('run.sh');\n  await copyToShellApp('maven'); // this is a symlink\n\n  // kernel.android.bundle isn't ever used in standalone apps (at least in kernel v32)\n  // but in order to not change behavior in older SDKs, we'll remove the file only in 32+.\n  if (parseSdkMajorVersion(sdkVersion) >= 32) {\n    try {\n      await fs.remove(path.join(shellPath, 'app/src/main/assets/kernel.android.bundle'));\n    } catch (e) {\n      // let's hope it's just not present in the shell app template\n    }\n  }\n}\n\nexports.createAndroidShellAppAsync = async function createAndroidShellAppAsync(args) {\n  let {\n    url,\n    sdkVersion,\n    releaseChannel,\n    privateConfigFile,\n    configuration,\n    keystore,\n    alias,\n    keystorePassword,\n    keyPassword,\n    outputFile,\n    workingDir,\n    modules,\n    buildType,\n    buildMode,\n  } = args;\n\n  const exponentDir = exponentDirectory(workingDir);\n  let androidSrcPath = path.join(exponentDir, 'android');\n  let shellPath = path.join(exponentDir, 'android-shell-app');\n\n  await fs.remove(shellPath);\n  await fs.ensureDir(shellPath);\n\n  releaseChannel = releaseChannel ? releaseChannel : 'default';\n  let manifest;\n  if (args.manifest) {\n    manifest = args.manifest;\n    logger\n      .withFields({ buildPhase: 'reading manifest' })\n      .info('Using manifest:', JSON.stringify(manifest));\n  } else {\n    manifest = await getManifestAsync(url, {\n      'Exponent-SDK-Version': sdkVersion,\n      'Exponent-Platform': 'android',\n      'Expo-Release-Channel': releaseChannel,\n      Accept: 'application/expo+json,application/json',\n    });\n  }\n\n  configuration = configuration ? configuration : 'Release';\n\n  let privateConfig;\n  if (privateConfigFile) {\n    let privateConfigContents = await fs.readFile(privateConfigFile, 'utf8');\n    privateConfig = JSON.parse(privateConfigContents);\n  } else if (manifest.android) {\n    privateConfig = manifest.android.config;\n  }\n\n  let androidBuildConfiguration;\n  if (keystore && alias && keystorePassword && keyPassword) {\n    androidBuildConfiguration = {\n      keystore,\n      keystorePassword,\n      keyAlias: alias,\n      keyPassword,\n      outputFile,\n    };\n  }\n\n  let buildFlags = StandaloneBuildFlags.createAndroid(configuration, androidBuildConfiguration);\n  let context = StandaloneContext.createServiceContext(\n    androidSrcPath,\n    null,\n    manifest,\n    privateConfig,\n    /* testEnvironment */ 'none',\n    buildFlags,\n    url,\n    releaseChannel\n  );\n\n  await copyInitialShellAppFilesAsync(androidSrcPath, shellPath, false, sdkVersion);\n  await removeObsoleteSdks(shellPath, sdkVersion);\n  await runShellAppModificationsAsync(context, sdkVersion, buildMode);\n  await prepareEnabledModules(shellPath, modules);\n\n  if (!args.skipBuild) {\n    await buildShellAppAsync(context, sdkVersion, buildType, buildMode);\n  }\n};\n\nfunction shellPathForContext(context) {\n  if (context.type === 'user') {\n    return path.join(context.data.projectPath, 'android');\n  } else {\n    return path.join(\n      exponentDirectory(\n        context.data.expoSourcePath && path.join(context.data.expoSourcePath, '..')\n      ),\n      'android-shell-app'\n    );\n  }\n}\n\n/**\n *  Resolve the private config for a project.\n *  For standalone apps, this is copied into a separate context field context.data.privateConfig\n *  by the turtle builder. For a local project, this is available in app.json under android.config.\n */\nfunction getPrivateConfig(context) {\n  if (context.data.privateConfig) {\n    return context.data.privateConfig;\n  } else {\n    const exp = context.data.exp;\n    if (exp && exp.android) {\n      return exp.android.config;\n    }\n  }\n}\n\nexport async function runShellAppModificationsAsync(context, sdkVersion, buildMode) {\n  const fnLogger = logger.withFields({ buildPhase: 'running shell app modifications' });\n\n  let shellPath = shellPathForContext(context);\n  let url = context.published.url;\n  let manifest = context.config; // manifest or app.json\n  let releaseChannel = context.published.releaseChannel;\n\n  const isRunningInUserContext = context.type === 'user';\n  // In SDK32 we've unified build process for shell and ejected apps\n  const isDetached = ExponentTools.parseSdkMajorVersion(sdkVersion) >= 32 || isRunningInUserContext;\n\n  const privateConfig = getPrivateConfig(context);\n  if (!privateConfig) {\n    fnLogger.info('No config file specified.');\n  }\n\n  let fullManifestUrl = url.replace('exp://', 'https://');\n\n  let versionCode = 1;\n  let javaPackage = manifest.android.package;\n  if (manifest.android.versionCode) {\n    versionCode = manifest.android.versionCode;\n  }\n\n  if (!javaPackage) {\n    throw new Error(\n      'Must specify androidPackage option (either from manifest or on command line).'\n    );\n  }\n\n  let name = manifest.name;\n  let scheme = manifest.scheme || (manifest.detach && manifest.detach.scheme);\n  let bundleUrl = manifest.bundleUrl;\n  let isFullManifest = !!bundleUrl;\n  let version = manifest.version ? manifest.version : '0.0.0';\n  let backgroundImages = backgroundImagesForApp(shellPath, manifest, isRunningInUserContext);\n  let splashBackgroundColor = getSplashScreenBackgroundColor(manifest);\n  let updatesDisabled = manifest.updates && manifest.updates.enabled === false;\n\n  // Clean build directories\n  await fs.remove(path.join(shellPath, 'app', 'build'));\n  await fs.remove(path.join(shellPath, 'ReactAndroid', 'build'));\n  await fs.remove(path.join(shellPath, 'expoview', 'build'));\n  await fs.remove(path.join(shellPath, 'app', 'src', 'test'));\n  await fs.remove(path.join(shellPath, 'app', 'src', 'androidTest'));\n\n  if (isDetached) {\n    let appBuildGradle = path.join(shellPath, 'app', 'build.gradle');\n    if (isRunningInUserContext) {\n      await regexFileAsync(/\\/\\* UNCOMMENT WHEN DETACHING/g, '', appBuildGradle);\n      await regexFileAsync(/END UNCOMMENT WHEN DETACHING \\*\\//g, '', appBuildGradle);\n      await deleteLinesInFileAsync(\n        'WHEN_DETACHING_REMOVE_FROM_HERE',\n        'WHEN_DETACHING_REMOVE_TO_HERE',\n        appBuildGradle\n      );\n    }\n    await regexFileAsync(/\\/\\* UNCOMMENT WHEN DISTRIBUTING/g, '', appBuildGradle);\n    await regexFileAsync(/END UNCOMMENT WHEN DISTRIBUTING \\*\\//g, '', appBuildGradle);\n    await deleteLinesInFileAsync(\n      'WHEN_DISTRIBUTING_REMOVE_FROM_HERE',\n      'WHEN_DISTRIBUTING_REMOVE_TO_HERE',\n      appBuildGradle\n    );\n\n    if (ExponentTools.parseSdkMajorVersion(sdkVersion) >= 33) {\n      let settingsGradle = path.join(shellPath, 'settings.gradle');\n      await deleteLinesInFileAsync(\n        'WHEN_DISTRIBUTING_REMOVE_FROM_HERE',\n        'WHEN_DISTRIBUTING_REMOVE_TO_HERE',\n        settingsGradle\n      );\n    } else {\n      // Don't need to compile expoview or ReactAndroid\n      // react-native link looks for a \\n so we need that. See https://github.com/facebook/react-native/blob/master/local-cli/link/android/patches/makeSettingsPatch.js\n      await fs.writeFile(path.join(shellPath, 'settings.gradle'), `include ':app'\\n`);\n    }\n\n    await regexFileAsync(\n      'TEMPLATE_INITIAL_URL',\n      url,\n      path.join(\n        shellPath,\n        'app',\n        'src',\n        'main',\n        'java',\n        'host',\n        'exp',\n        'exponent',\n        'MainActivity.java'\n      )\n    );\n\n    const runShPath = path.join(shellPath, 'run.sh');\n    if (await fs.pathExists(runShPath)) {\n      await regexFileAsync('host.exp.exponent/', `${javaPackage}/`, runShPath);\n      await regexFileAsync('LauncherActivity', 'MainActivity', runShPath);\n    }\n  }\n\n  // Package\n  await regexFileAsync(\n    `applicationId 'host.exp.exponent'`,\n    `applicationId '${javaPackage}'`,\n    path.join(shellPath, 'app', 'build.gradle')\n  );\n  await regexFileAsync(\n    `android:name=\"host.exp.exponent\"`,\n    `android:name=\"${javaPackage}\"`,\n    path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n  );\n\n  // Versions\n  await regexFileAsync(\n    'VERSION_NAME = null',\n    `VERSION_NAME = \"${version}\"`,\n    path.join(\n      shellPath,\n      'app',\n      'src',\n      'main',\n      'java',\n      'host',\n      'exp',\n      'exponent',\n      'generated',\n      'AppConstants.java'\n    )\n  );\n  await deleteLinesInFileAsync(\n    `BEGIN VERSIONS`,\n    `END VERSIONS`,\n    path.join(shellPath, 'app', 'build.gradle')\n  );\n  await regexFileAsync(\n    '// ADD VERSIONS HERE',\n    `versionCode ${versionCode}\n    versionName '${version}'`,\n    path.join(shellPath, 'app', 'build.gradle')\n  );\n\n  // Remove Exponent build script, since SDK32 expoview comes precompiled\n  if (parseSdkMajorVersion(sdkVersion) < 32 && !isRunningInUserContext) {\n    await regexFileAsync(\n      `preBuild.dependsOn generateDynamicMacros`,\n      ``,\n      path.join(shellPath, 'expoview', 'build.gradle')\n    );\n  }\n\n  // change javaMaxHeapSize\n  await regexFileAsync(\n    `javaMaxHeapSize \"8g\"`,\n    `javaMaxHeapSize \"6g\"`,\n    path.join(shellPath, 'app', 'build.gradle')\n  );\n\n  // Push notifications\n  await regexFileAsync(\n    '\"package_name\": \"host.exp.exponent\"',\n    `\"package_name\": \"${javaPackage}\"`,\n    path.join(shellPath, 'app', 'google-services.json')\n  ); // TODO: actually use the correct file\n\n  // TODO: probably don't need this in both places\n  await regexFileAsync(\n    /host\\.exp\\.exponent\\.permission\\.C2D_MESSAGE/g,\n    `${javaPackage}.permission.C2D_MESSAGE`,\n    path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n  );\n  // Since SDK32 expoview comes precompiled\n  if (parseSdkMajorVersion(sdkVersion) < 32 && !isRunningInUserContext) {\n    await regexFileAsync(\n      /host\\.exp\\.exponent\\.permission\\.C2D_MESSAGE/g,\n      `${javaPackage}.permission.C2D_MESSAGE`,\n      path.join(shellPath, 'expoview', 'src', 'main', 'AndroidManifest.xml')\n    );\n  }\n\n  // Set INITIAL_URL, SHELL_APP_SCHEME and SHOW_LOADING_VIEW\n  await regexFileAsync(\n    'INITIAL_URL = null',\n    `INITIAL_URL = \"${url}\"`,\n    path.join(\n      shellPath,\n      'app',\n      'src',\n      'main',\n      'java',\n      'host',\n      'exp',\n      'exponent',\n      'generated',\n      'AppConstants.java'\n    )\n  );\n  if (scheme) {\n    await regexFileAsync(\n      'SHELL_APP_SCHEME = null',\n      `SHELL_APP_SCHEME = \"${scheme}\"`,\n      path.join(\n        shellPath,\n        'app',\n        'src',\n        'main',\n        'java',\n        'host',\n        'exp',\n        'exponent',\n        'generated',\n        'AppConstants.java'\n      )\n    );\n  }\n\n  // Handle 'contain' and 'cover' splashScreen mode by showing only background color and then actual splashScreen image inside AppLoadingView\n  if (shouldShowLoadingView(manifest, sdkVersion)) {\n    await regexFileAsync(\n      'SHOW_LOADING_VIEW_IN_SHELL_APP = false',\n      'SHOW_LOADING_VIEW_IN_SHELL_APP = true',\n      path.join(\n        shellPath,\n        'app',\n        'src',\n        'main',\n        'java',\n        'host',\n        'exp',\n        'exponent',\n        'generated',\n        'AppConstants.java'\n      )\n    );\n\n    // show only background color if LoadingView will appear\n    await regexFileAsync(\n      /<item>.*<\\/item>/,\n      '',\n      path.join(shellPath, 'app', 'src', 'main', 'res', 'drawable', 'splash_background.xml')\n    );\n  }\n\n  // In SDK32 this field got removed from AppConstants\n  if (parseSdkMajorVersion(sdkVersion) < 32 && isRunningInUserContext) {\n    await regexFileAsync(\n      'IS_DETACHED = false',\n      `IS_DETACHED = true`,\n      path.join(\n        shellPath,\n        'app',\n        'src',\n        'main',\n        'java',\n        'host',\n        'exp',\n        'exponent',\n        'generated',\n        'AppConstants.java'\n      )\n    );\n  }\n  if (updatesDisabled) {\n    await regexFileAsync(\n      'ARE_REMOTE_UPDATES_ENABLED = true',\n      'ARE_REMOTE_UPDATES_ENABLED = false',\n      path.join(\n        shellPath,\n        'app',\n        'src',\n        'main',\n        'java',\n        'host',\n        'exp',\n        'exponent',\n        'generated',\n        'AppConstants.java'\n      )\n    );\n  }\n\n  // App name\n  await regexFileAsync(\n    '\"app_name\">Expo',\n    `\"app_name\">${xmlWeirdAndroidEscape(name)}`,\n    path.join(shellPath, 'app', 'src', 'main', 'res', 'values', 'strings.xml')\n  );\n\n  // Splash Screen background color\n  await regexFileAsync(\n    '\"splashBackground\">#FFFFFF',\n    `\"splashBackground\">${splashBackgroundColor}`,\n    path.join(shellPath, 'app', 'src', 'main', 'res', 'values', 'colors.xml')\n  );\n\n  // Change stripe schemes and add meta-data\n  const randomID = uuid.v4();\n  const newScheme = `<meta-data android:name=\"standaloneStripeScheme\" android:value=\"${randomID}\" />`;\n  await regexFileAsync(\n    '<!-- ADD HERE STRIPE SCHEME META DATA -->',\n    newScheme,\n    path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n  );\n\n  const newSchemeSuffix = `expo.modules.payments.stripe.${randomID}\" />`;\n  await regexFileAsync(\n    'expo.modules.payments.stripe\" />',\n    newSchemeSuffix,\n    path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n  );\n\n  // Remove exp:// scheme from LauncherActivity\n  await deleteLinesInFileAsync(\n    `START LAUNCHER INTENT FILTERS`,\n    `END LAUNCHER INTENT FILTERS`,\n    path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n  );\n\n  // Remove LAUNCHER category from HomeActivity\n  await deleteLinesInFileAsync(\n    `START HOME INTENT FILTERS`,\n    `END HOME INTENT FILTERS`,\n    path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n  );\n\n  if (isDetached) {\n    // Add LAUNCHER category to MainActivity\n    await regexFileAsync(\n      '<!-- ADD DETACH INTENT FILTERS HERE -->',\n      `<intent-filter>\n        <action android:name=\"android.intent.action.MAIN\"/>\n\n        <category android:name=\"android.intent.category.LAUNCHER\"/>\n      </intent-filter>`,\n      path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n    );\n  } else {\n    // Add LAUNCHER category to ShellAppActivity\n    await regexFileAsync(\n      '<!-- ADD SHELL INTENT FILTERS HERE -->',\n      `<intent-filter>\n        <action android:name=\"android.intent.action.MAIN\"/>\n\n        <category android:name=\"android.intent.category.LAUNCHER\"/>\n      </intent-filter>`,\n      path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n    );\n  }\n\n  // Add app-specific intent filters\n  const intentFilters = _.get(manifest, 'android.intentFilters');\n  if (intentFilters) {\n    if (isDetached) {\n      await regexFileAsync(\n        '<!-- ADD DETACH APP SPECIFIC INTENT FILTERS -->',\n        renderIntentFilters(intentFilters).join('\\n'),\n        path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n      );\n    } else {\n      await regexFileAsync(\n        '<!-- ADD SHELL APP SPECIFIC INTENT FILTERS -->',\n        renderIntentFilters(intentFilters).join('\\n'),\n        path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n      );\n    }\n  }\n\n  // Add shell app scheme\n  const schemes = [scheme].filter(e => e);\n  if (schemes.length > 0) {\n    const searchLine = isDetached\n      ? '<!-- ADD DETACH SCHEME HERE -->'\n      : '<!-- ADD SHELL SCHEME HERE -->';\n    const schemesTags = schemes.map(scheme => `<data android:scheme=\"${scheme}\"/>`).join(`\n    `);\n    await regexFileAsync(\n      searchLine,\n      `<intent-filter>\n        ${schemesTags}\n\n        <action android:name=\"android.intent.action.VIEW\"/>\n\n        <category android:name=\"android.intent.category.DEFAULT\"/>\n        <category android:name=\"android.intent.category.BROWSABLE\"/>\n      </intent-filter>`,\n      path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n    );\n  }\n  // Add Facebook app scheme\n  if (manifest.facebookScheme) {\n    await regexFileAsync(\n      '<!-- REPLACE WITH FACEBOOK SCHEME -->',\n      `<data android:scheme=\"${manifest.facebookScheme}\" />`,\n      path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n    );\n  }\n\n  // Add permissions\n  if (manifest.android && manifest.android.permissions) {\n    const whitelist = [];\n\n    manifest.android.permissions.forEach(s => {\n      if (s.includes('.')) {\n        whitelist.push(s);\n      } else {\n        // If shorthand form like `WRITE_CONTACTS` is provided, expand it to `android.permission.WRITE_CONTACTS`.\n        whitelist.push(`android.permission.${s}`);\n      }\n    });\n\n    // Permissions we need to remove from the generated manifest\n    const blacklist = [\n      'android.permission.ACCESS_COARSE_LOCATION',\n      'android.permission.ACCESS_FINE_LOCATION',\n      'android.permission.CAMERA',\n      'android.permission.MANAGE_DOCUMENTS',\n      'android.permission.READ_CONTACTS',\n      'android.permission.WRITE_CONTACTS',\n      'android.permission.READ_CALENDAR',\n      'android.permission.WRITE_CALENDAR',\n      'android.permission.READ_EXTERNAL_STORAGE',\n      'android.permission.READ_INTERNAL_STORAGE',\n      'android.permission.READ_PHONE_STATE',\n      'android.permission.RECORD_AUDIO',\n      'android.permission.USE_FINGERPRINT',\n      'android.permission.VIBRATE',\n      'android.permission.WRITE_EXTERNAL_STORAGE',\n      'android.permission.READ_SMS',\n      'com.anddoes.launcher.permission.UPDATE_COUNT',\n      'com.android.launcher.permission.INSTALL_SHORTCUT',\n      'com.google.android.gms.permission.ACTIVITY_RECOGNITION',\n      'com.google.android.providers.gsf.permission.READ_GSERVICES',\n      'com.htc.launcher.permission.READ_SETTINGS',\n      'com.htc.launcher.permission.UPDATE_SHORTCUT',\n      'com.majeur.launcher.permission.UPDATE_BADGE',\n      'com.sec.android.provider.badge.permission.READ',\n      'com.sec.android.provider.badge.permission.WRITE',\n      'com.sonyericsson.home.permission.BROADCAST_BADGE',\n    ].filter(p => !whitelist.includes(p));\n\n    await deleteLinesInFileAsync(\n      `BEGIN OPTIONAL PERMISSIONS`,\n      `END OPTIONAL PERMISSIONS`,\n      path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n    );\n\n    await regexFileAsync(\n      '<!-- ADD PERMISSIONS HERE -->',\n      `\n      ${whitelist.map(p => `<uses-permission android:name=\"${p}\" />`).join('\\n')}\n      ${blacklist\n        .map(p => `<uses-permission android:name=\"${p}\" tools:node=\"remove\" />`)\n        .join('\\n')}\n      `,\n      path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n    );\n  }\n\n  // OAuth redirect scheme\n  await regexFileAsync(\n    '<data android:scheme=\"host.exp.exponent\" android:path=\"oauthredirect\"/>',\n    `<data android:scheme=\"${javaPackage}\" android:path=\"oauthredirect\"/>`,\n    path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n  );\n\n  // Embed manifest and bundle\n  if (isFullManifest) {\n    await fs.writeFileSync(\n      path.join(shellPath, 'app', 'src', 'main', 'assets', 'shell-app-manifest.json'),\n      JSON.stringify(manifest)\n    );\n    await saveUrlToPathAsync(\n      bundleUrl,\n      path.join(shellPath, 'app', 'src', 'main', 'assets', 'shell-app.bundle')\n    );\n\n    await regexFileAsync(\n      '// START EMBEDDED RESPONSES',\n      `\n      // START EMBEDDED RESPONSES\n      embeddedResponses.add(new Constants.EmbeddedResponse(\"${fullManifestUrl}\", \"assets://shell-app-manifest.json\", \"application/json\"));\n      embeddedResponses.add(new Constants.EmbeddedResponse(\"${bundleUrl}\", \"assets://shell-app.bundle\", \"application/javascript\"));`,\n      path.join(\n        shellPath,\n        'app',\n        'src',\n        'main',\n        'java',\n        'host',\n        'exp',\n        'exponent',\n        'generated',\n        'AppConstants.java'\n      )\n    );\n  }\n\n  await regexFileAsync(\n    'RELEASE_CHANNEL = \"default\"',\n    `RELEASE_CHANNEL = \"${releaseChannel}\"`,\n    path.join(\n      shellPath,\n      'app',\n      'src',\n      'main',\n      'java',\n      'host',\n      'exp',\n      'exponent',\n      'generated',\n      'AppConstants.java'\n    )\n  );\n\n  // Icons\n  createAndWriteIconsToPathAsync(\n    context,\n    path.join(shellPath, 'app', 'src', 'main', 'res'),\n    isRunningInUserContext\n  );\n\n  // Splash Background\n  if (backgroundImages && backgroundImages.length > 0) {\n    // Delete the placeholder images\n    (\n      await globby(['**/shell_launch_background_image.png'], {\n        cwd: path.join(shellPath, 'app', 'src', 'main', 'res'),\n        absolute: true,\n      })\n    ).forEach(filePath => {\n      fs.removeSync(filePath);\n    });\n\n    await Promise.all(\n      backgroundImages.map(async image => {\n        if (isRunningInUserContext) {\n          // local file so just copy it\n          await fs.copy(path.resolve(context.data.projectPath, image.url), image.path);\n        } else {\n          await saveUrlToPathAsync(image.url, image.path);\n        }\n      })\n    );\n  }\n\n  await AssetBundle.bundleAsync(\n    context,\n    manifest.bundledAssets,\n    `${shellPath}/app/src/main/assets`\n  );\n\n  let certificateHash = '';\n  let googleAndroidApiKey = '';\n  if (privateConfig) {\n    let branch = privateConfig.branch;\n    let fabric = privateConfig.fabric;\n    let googleMaps = privateConfig.googleMaps;\n    let googleSignIn = privateConfig.googleSignIn;\n    let googleMobileAdsAppId = privateConfig.googleMobileAdsAppId;\n    let googleMobileAdsAutoInit = privateConfig.googleMobileAdsAutoInit;\n\n    // Branch\n    if (branch) {\n      await regexFileAsync(\n        '<!-- ADD BRANCH CONFIG HERE -->',\n        `<meta-data\n      android:name=\"io.branch.sdk.BranchKey\"\n      android:value=\"${branch.apiKey}\"/>`,\n        path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n      );\n    }\n\n    // Fabric\n    // Delete existing Fabric API key.\n    await deleteLinesInFileAsync(\n      `BEGIN FABRIC CONFIG`,\n      `END FABRIC CONFIG`,\n      path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n    );\n    await fs.remove(path.join(shellPath, 'app', 'fabric.properties'));\n\n    if (fabric) {\n      // Put user's Fabric key if provided.\n      await fs.writeFileSync(\n        path.join(shellPath, 'app', 'fabric.properties'),\n        `apiSecret=${fabric.buildSecret}\\n`\n      );\n\n      await regexFileAsync(\n        '<!-- ADD FABRIC CONFIG HERE -->',\n        `<meta-data\n      android:name=\"io.fabric.ApiKey\"\n      android:value=\"${fabric.apiKey}\"/>`,\n        path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n      );\n    }\n\n    // Google Maps\n    // Delete existing Google Maps API key.\n    await deleteLinesInFileAsync(\n      `BEGIN GOOGLE MAPS CONFIG`,\n      `END GOOGLE MAPS CONFIG`,\n      path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n    );\n\n    if (googleMaps) {\n      // Put user's Google Maps API key if provided.\n      await regexFileAsync(\n        '<!-- ADD GOOGLE MAPS CONFIG HERE -->',\n        `<meta-data\n      android:name=\"com.google.android.geo.API_KEY\"\n      android:value=\"${googleMaps.apiKey}\"/>`,\n        path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n      );\n    }\n\n    // Google Mobile Ads App ID\n    // The app crashes if the app ID isn't provided, so if the user\n    // doesn't provide the ID, we leave the sample one.\n    if (googleMobileAdsAppId) {\n      // Delete existing Google Mobile Ads App ID.\n      await deleteLinesInFileAsync(\n        `BEGIN GOOGLE MOBILE ADS CONFIG`,\n        `END GOOGLE MOBILE ADS CONFIG`,\n        path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n      );\n      // Put user's Google Mobile Ads App ID if provided.\n      await regexFileAsync(\n        '<!-- ADD GOOGLE MOBILE ADS CONFIG HERE -->',\n        `<meta-data\n      android:name=\"com.google.android.gms.ads.APPLICATION_ID\"\n      android:value=\"${googleMobileAdsAppId}\"/>`,\n        path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n      );\n    }\n\n    // Auto-init of Google App Measurement\n    // unless the user explicitly specifies they want to auto-init, we leave delay set to true\n    if (googleMobileAdsAutoInit) {\n      await regexFileAsync(\n        '<meta-data android:name=\"com.google.android.gms.ads.DELAY_APP_MEASUREMENT_INIT\" android:value=\"true\"/>',\n        '<meta-data android:name=\"com.google.android.gms.ads.DELAY_APP_MEASUREMENT_INIT\" android:value=\"false\"/>',\n        path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n      );\n    }\n\n    // Google Login\n    if (googleSignIn) {\n      certificateHash = googleSignIn.certificateHash;\n      googleAndroidApiKey = googleSignIn.apiKey;\n    }\n  }\n\n  if (manifest.android && manifest.android.googleServicesFile) {\n    // google-services.json\n    // Used for configuring FCM\n    let googleServicesFileContents = manifest.android.googleServicesFile;\n    if (isRunningInUserContext) {\n      googleServicesFileContents = await fs.readFile(\n        path.resolve(shellPath, '..', manifest.android.googleServicesFile),\n        'utf8'\n      );\n    }\n    await fs.writeFile(\n      path.join(shellPath, 'app', 'google-services.json'),\n      googleServicesFileContents\n    );\n  } else {\n    await regexFileAsync(\n      'FCM_ENABLED = true',\n      'FCM_ENABLED = false',\n      path.join(\n        shellPath,\n        'app',\n        'src',\n        'main',\n        'java',\n        'host',\n        'exp',\n        'exponent',\n        'generated',\n        'AppConstants.java'\n      )\n    );\n  }\n\n  // Set manifest url for debug mode\n  if (buildMode === 'debug') {\n    await regexFileAsync(\n      'DEVELOPMENT_URL = \"\"',\n      `DEVELOPMENT_URL = \"${fullManifestUrl}\"`,\n      path.join(\n        shellPath,\n        'app',\n        'src',\n        'main',\n        'java',\n        'host',\n        'exp',\n        'exponent',\n        'generated',\n        'DetachBuildConstants.java'\n      )\n    );\n  }\n\n  // Google sign in\n  await regexFileAsync(\n    /\"current_key\": \"(.*?)\"/,\n    `\"current_key\": \"${googleAndroidApiKey}\"`,\n    path.join(shellPath, 'app', 'google-services.json')\n  );\n  await regexFileAsync(\n    /\"certificate_hash\": \"(.*?)\"/,\n    `\"certificate_hash\": \"${certificateHash}\"`,\n    path.join(shellPath, 'app', 'google-services.json')\n  );\n\n  // Facebook configuration\n\n  // There's no such pattern to replace in shell apps below SDK 36,\n  // so this will not have any effect on these apps.\n  if (manifest.facebookAppId) {\n    await regexFileAsync(\n      '<!-- ADD FACEBOOK APP ID CONFIG HERE -->',\n      `<meta-data android:name=\"com.facebook.sdk.ApplicationId\" android:value=\"${manifest.facebookAppId}\"/>`,\n      path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n    );\n  }\n  // There's no such pattern to replace in shell apps below SDK 36,\n  // so this will not have any effect on these apps.\n  if (manifest.facebookDisplayName) {\n    await regexFileAsync(\n      '<!-- ADD FACEBOOK APP DISPLAY NAME CONFIG HERE -->',\n      `<meta-data android:name=\"com.facebook.sdk.ApplicationName\" android:value=\"${manifest.facebookDisplayName}\"/>`,\n      path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n    );\n  }\n  // There's no such pattern to replace in shell apps below SDK 36,\n  // so this will not have any effect on these apps.\n  if (manifest.facebookAutoInitEnabled) {\n    await regexFileAsync(\n      '<meta-data android:name=\"com.facebook.sdk.AutoInitEnabled\" android:value=\"false\"/>',\n      '<meta-data android:name=\"com.facebook.sdk.AutoInitEnabled\" android:value=\"true\"/>',\n      path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n    );\n  }\n  // There's no such pattern to replace in shell apps below SDK 36,\n  // so this will not have any effect on these apps.\n  if (manifest.facebookAutoLogAppEventsEnabled) {\n    await regexFileAsync(\n      '<meta-data android:name=\"com.facebook.sdk.AutoLogAppEventsEnabled\" android:value=\"false\"/>',\n      '<meta-data android:name=\"com.facebook.sdk.AutoLogAppEventsEnabled\" android:value=\"true\"/>',\n      path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n    );\n  }\n  // There's no such pattern to replace in shell apps below SDK 36,\n  // so this will not have any effect on these apps.\n  if (manifest.facebookAdvertiserIDCollectionEnabled) {\n    await regexFileAsync(\n      '<meta-data android:name=\"com.facebook.sdk.AdvertiserIDCollectionEnabled\" android:value=\"false\"/>',\n      '<meta-data android:name=\"com.facebook.sdk.AdvertiserIDCollectionEnabled\" android:value=\"true\"/>',\n      path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n    );\n  }\n}\n\nasync function buildShellAppAsync(context, sdkVersion, buildType, buildMode) {\n  let shellPath = shellPathForContext(context);\n  const ext = buildType === 'app-bundle' ? 'aab' : 'apk';\n\n  const isRelease = !!context.build.android && buildMode === 'release';\n  // concat on those strings is not very readable, but only alternative here is huge if statement\n  const debugOrRelease = isRelease ? 'Release' : 'Debug';\n  const devOrProd = isRelease ? 'Prod' : 'Dev';\n  const debugOrReleaseL = isRelease ? 'release' : 'debug';\n  const devOrProdL = isRelease ? 'prod' : 'dev';\n\n  const shellFile = `shell.${ext}`;\n  const shellUnalignedFile = `shell-unaligned.${ext}`;\n\n  const outputDirPath = path.join(\n    shellPath,\n    'app',\n    'build',\n    'outputs',\n    buildType === 'app-bundle' ? 'bundle' : 'apk'\n  );\n\n  let gradleBuildCommand;\n  let outputPath;\n  if (buildType === 'app-bundle') {\n    if (ExponentTools.parseSdkMajorVersion(sdkVersion) >= 36) {\n      gradleBuildCommand = `bundle${debugOrRelease}`;\n      outputPath = path.join(outputDirPath, debugOrReleaseL, `app-${debugOrReleaseL}.aab`);\n    } else if (ExponentTools.parseSdkMajorVersion(sdkVersion) >= 33) {\n      gradleBuildCommand = `bundle${debugOrRelease}`;\n      outputPath = path.join(outputDirPath, debugOrReleaseL, `app.aab`);\n    } else if (ExponentTools.parseSdkMajorVersion(sdkVersion) >= 32) {\n      gradleBuildCommand = `bundle${devOrProd}Kernel${debugOrRelease}`;\n      outputPath = path.join(outputDirPath, `${devOrProdL}Kernel${debugOrRelease}`, `app.aab`);\n    } else {\n      // gradleBuildCommand = `bundle${devOrProd}MinSdk${devOrProd}Kernel${debugOrRelease}`;\n      // outputPath = path.join(\n      //   outputDirPath,\n      //   `${devOrProdL}MinSdk${devOrProd}Kernel`,\n      //   debugOrReleaseL,\n      //   `app.aab`\n      // );\n\n      // TODO (wkozyra95) debug building app bundles for sdk 31 and older\n      // for now it has low priority\n      throw new Error('Android App Bundles are not supported for sdk31 and lower');\n    }\n  } else {\n    if (ExponentTools.parseSdkMajorVersion(sdkVersion) >= 33) {\n      gradleBuildCommand = `assemble${debugOrRelease}`;\n      outputPath = path.join(outputDirPath, debugOrReleaseL, `app-${debugOrReleaseL}.apk`);\n    } else if (ExponentTools.parseSdkMajorVersion(sdkVersion) >= 32) {\n      gradleBuildCommand = `assemble${devOrProd}Kernel${debugOrRelease}`;\n      outputPath = path.join(\n        outputDirPath,\n        `${devOrProdL}Kernel`,\n        debugOrReleaseL,\n        `app-${devOrProdL}Kernel-${debugOrReleaseL}.apk`\n      );\n    } else {\n      gradleBuildCommand = `assemble${devOrProd}MinSdk${devOrProd}Kernel${debugOrRelease}`;\n      outputPath = path.join(\n        outputDirPath,\n        `${devOrProdL}MinSdk${devOrProd}Kernel`,\n        debugOrReleaseL,\n        `app-${devOrProdL}MinSdk-${devOrProdL}Kernel-${debugOrReleaseL}-unsigned.apk`\n      );\n    }\n  }\n\n  await ExponentTools.removeIfExists(shellUnalignedFile);\n  await ExponentTools.removeIfExists(shellFile);\n  await ExponentTools.removeIfExists(outputPath);\n  if (isRelease) {\n    const androidBuildConfiguration = context.build.android;\n\n    const gradleArgs = [gradleBuildCommand];\n    if (process.env.GRADLE_DAEMON_DISABLED) {\n      gradleArgs.unshift('--no-daemon');\n    }\n    await spawnAsyncThrowError(`./gradlew`, gradleArgs, {\n      pipeToLogger: true,\n      loggerFields: { buildPhase: 'running gradle' },\n      cwd: shellPath,\n      env: {\n        ...process.env,\n        ANDROID_KEY_ALIAS: androidBuildConfiguration.keyAlias,\n        ANDROID_KEY_PASSWORD: androidBuildConfiguration.keyPassword,\n        ANDROID_KEYSTORE_PATH: androidBuildConfiguration.keystore,\n        ANDROID_KEYSTORE_PASSWORD: androidBuildConfiguration.keystorePassword,\n      },\n    });\n\n    if (ExponentTools.parseSdkMajorVersion(sdkVersion) >= 32) {\n      await fs.copy(outputPath, shellFile);\n      // -c means \"only verify\"\n      await spawnAsync(`zipalign`, ['-c', '-v', '4', shellFile], {\n        pipeToLogger: true,\n        loggerFields: { buildPhase: 'verifying apk alignment' },\n      });\n    } else {\n      await fs.copy(outputPath, shellUnalignedFile);\n      await spawnAsync(\n        `jarsigner`,\n        [\n          '-verbose',\n          '-sigalg',\n          'SHA1withRSA',\n          '-digestalg',\n          'SHA1',\n          '-storepass',\n          androidBuildConfiguration.keystorePassword,\n          '-keypass',\n          androidBuildConfiguration.keyPassword,\n          '-keystore',\n          androidBuildConfiguration.keystore,\n          shellUnalignedFile,\n          androidBuildConfiguration.keyAlias,\n        ],\n        {\n          pipeToLogger: true,\n          loggerFields: { buildPhase: 'signing created apk' },\n        }\n      );\n      await spawnAsync(`zipalign`, ['-v', '4', shellUnalignedFile, shellFile], {\n        pipeToLogger: true,\n        loggerFields: { buildPhase: 'verifying apk alignment' },\n      });\n      await ExponentTools.removeIfExists(shellUnalignedFile);\n    }\n    await spawnAsync(\n      `jarsigner`,\n      ['-verify', '-verbose', '-certs', '-keystore', androidBuildConfiguration.keystore, shellFile],\n      {\n        pipeToLogger: true,\n        loggerFields: { buildPhase: 'verifying apk' },\n      }\n    );\n    await fs.copy(shellFile, androidBuildConfiguration.outputFile || `/tmp/shell-signed.${ext}`);\n    await ExponentTools.removeIfExists(shellFile);\n  } else {\n    await spawnAsyncThrowError(`./gradlew`, [gradleBuildCommand], {\n      pipeToLogger: true,\n      loggerFields: { buildPhase: 'running gradle' },\n      cwd: shellPath,\n    });\n    await fs.copy(\n      outputPath,\n      _.get(context, 'build.android.outputFile') || `/tmp/shell-debug.${ext}`\n    );\n    await ExponentTools.removeIfExists(outputPath);\n  }\n}\n\nexport function addDetachedConfigToExp(exp, context) {\n  if (context.type !== 'user') {\n    console.warn(`Tried to modify exp for a non-user StandaloneContext, ignoring`);\n    return exp;\n  }\n  let shellPath = shellPathForContext(context);\n  let assetsDirectory = path.join(shellPath, 'app', 'src', 'main', 'assets');\n  exp.android.publishBundlePath = path.relative(\n    context.data.projectPath,\n    path.join(assetsDirectory, 'shell-app.bundle')\n  );\n  exp.android.publishManifestPath = path.relative(\n    context.data.projectPath,\n    path.join(assetsDirectory, 'shell-app-manifest.json')\n  );\n  return exp;\n}\n\n/**\n\nSome files in `android` directory have the following patterns of code:\n\n```\n// WHEN_PREPARING_SHELL_REMOVE_FROM_HERE\n\n// BEGIN_SDK_30\nsome SDK 30-specific code\n// END_SDK_30\n\n// BEGIN_SDK_29\nsome SDK 29-specific code\n// END_SDK_29\n\n...\n\n// WHEN_PREPARING_SHELL_REMOVE_TO_HERE\n```\n\nThe following function replaces all `BEGIN_SDK_XX` with `REMOVE_TO_HERE`\nand all `END_SDK_XX` with `REMOVE_FROM_HERE`, so after the change the code above would read:\n\n```\n// WHEN_PREPARING_SHELL_REMOVE_FROM_HERE\n\n// WHEN_PREPARING_SHELL_REMOVE_TO_HERE       <--- changed\nsome SDK 30-specific code\n// WHEN_PREPARING_SHELL_REMOVE_FROM_HERE     <--- changed\n\n// BEGIN_SDK_29\nsome SDK 29-specific code\n// END_SDK_29\n\n...\n\n// WHEN_PREPARING_SHELL_REMOVE_TO_HERE\n```\n\nThis allows us to use `deleteLinesInFileAsync` function to remove obsolete SDKs code easily.\n\n */\nconst removeInvalidSdkLinesWhenPreparingShell = async (majorSdkVersion, filePath) => {\n  await regexFileAsync(\n    new RegExp(`BEGIN_SDK_${majorSdkVersion}`, 'g'),\n    `WHEN_PREPARING_SHELL_REMOVE_TO_HERE`,\n    filePath\n  );\n  await regexFileAsync(\n    new RegExp(`END_SDK_${majorSdkVersion}`, 'g'),\n    `WHEN_PREPARING_SHELL_REMOVE_FROM_HERE`,\n    filePath\n  );\n  await deleteLinesInFileAsync(\n    /WHEN_PREPARING_SHELL_REMOVE_FROM_HERE/g,\n    'WHEN_PREPARING_SHELL_REMOVE_TO_HERE',\n    filePath\n  );\n};\n\nasync function removeObsoleteSdks(shellPath, requiredSdkVersion) {\n  const filePathsToTransform = {\n    // Remove obsolete `expoview-abiXX_X_X` dependencies\n    appBuildGradle: path.join(shellPath, 'app/build.gradle'),\n    // Remove obsolete `host.exp.exponent:reactandroid:XX.X.X` dependencies from expoview\n    expoviewBuildGradle: path.join(shellPath, 'expoview/build.gradle'),\n    // Remove obsolete includeUnimodulesProjects\n    settingsBuildGradle: path.join(shellPath, 'settings.gradle'),\n    // Remove no-longer-valid interfaces from MultipleVersionReactNativeActivity\n    multipleVersionReactNativeActivity: path.join(\n      shellPath,\n      'expoview/src/main/java/host/exp/exponent/experience/MultipleVersionReactNativeActivity.java'\n    ),\n    // Remove invalid ABI versions from Constants\n    constants: path.join(shellPath, 'expoview/src/main/java/host/exp/exponent/Constants.java'),\n    // Remove non-existent DevSettingsActivities\n    appAndroidManifest: path.join(shellPath, 'app/src/main/AndroidManifest.xml'),\n  };\n\n  const majorSdkVersion = parseSdkMajorVersion(requiredSdkVersion);\n\n  // The single SDK change will happen when transitioning from SDK 30 to 31.\n  // Since SDK 31 there will be no versioned ABIs in shell applications, only unversioned one.\n  // And as such, we will treat the unversioned ABI as the SDK one by assigning TEMPORARY_ABI_VERSION.\n  const effectiveSdkVersion = majorSdkVersion > 30 ? 'UNVERSIONED' : `${majorSdkVersion}`;\n\n  if (effectiveSdkVersion === 'UNVERSIONED') {\n    await regexFileAsync(\n      'TEMPORARY_ABI_VERSION = null;',\n      `TEMPORARY_ABI_VERSION = \"${requiredSdkVersion}\";`,\n      filePathsToTransform.constants\n    );\n  }\n\n  await Promise.all(\n    Object.values(filePathsToTransform).map(filePath =>\n      removeInvalidSdkLinesWhenPreparingShell(effectiveSdkVersion, filePath)\n    )\n  );\n}\n\nasync function prepareEnabledModules(shellPath, modules) {\n  const enabledModulesDir = path.join(shellPath, 'enabled-modules');\n  const packagesDir = path.join(shellPath, '..', 'packages');\n  await fs.remove(enabledModulesDir);\n  if (!modules) {\n    await fs.ensureSymlink(packagesDir, enabledModulesDir);\n  } else {\n    await fs.mkdirp(enabledModulesDir);\n    await Promise.all(\n      modules.map(mod =>\n        fs.ensureSymlink(\n          path.join(packagesDir, mod.dirname),\n          path.join(enabledModulesDir, mod.dirname)\n        )\n      )\n    );\n  }\n}\n"],"sourceRoot":"/@expo/xdl@57.7.1/src"}